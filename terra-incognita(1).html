<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Terra">
<meta name="theme-color" content="#0a0e17">
<title>Terra Incognita</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<style>
:root{--bg:#0a0e17;--card:rgba(17,24,39,.93);--accent:#6ec4a8;--adim:#3a7d66;--glow:rgba(110,196,168,.4);--t1:#e8ece9;--t2:#7a8a82;--t3:#4a5a52;--bdr:rgba(110,196,168,.12);--r:16px}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;width:100%;overflow:hidden;font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--t1);-webkit-font-smoothing:antialiased;touch-action:none}

/* SPLASH */
#splash{position:fixed;inset:0;z-index:2000;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity .8s,visibility .8s}
#splash.hidden{opacity:0;visibility:hidden;pointer-events:none}
.logo-mark{width:80px;height:80px;border-radius:50%;border:2px solid var(--accent);display:flex;align-items:center;justify-content:center;margin-bottom:32px;animation:pulse 2.5s ease-in-out infinite}
@keyframes pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.05);opacity:.7}}
.logo-mark svg{width:36px;height:36px}
#splash h1{font-family:'Cormorant Garamond',serif;font-size:32px;font-weight:300;letter-spacing:6px;text-transform:uppercase;margin-bottom:8px}
#splash .sub{font-size:13px;color:var(--t2);letter-spacing:3px;text-transform:uppercase;margin-bottom:48px}
.start-btn{background:0 0;border:1px solid var(--accent);color:var(--accent);padding:14px 48px;border-radius:40px;font-size:14px;font-weight:500;letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:.3s;font-family:inherit}
.start-btn:hover{background:var(--accent);color:var(--bg);box-shadow:0 0 30px var(--glow)}
.hint{margin-top:32px;max-width:300px;text-align:center;font-size:11px;color:var(--t3);line-height:1.7;opacity:0;animation:fadeIn 1s 1.5s forwards}
.hint strong{color:var(--t2)}
@keyframes fadeIn{to{opacity:1}}

/* MAP */
#map{position:absolute;inset:0;z-index:1;background:var(--bg)}
.leaflet-control-attribution{display:none!important}
.leaflet-control-zoom{display:none!important}
#fog{position:absolute;inset:0;z-index:500;pointer-events:none}
#heat{position:absolute;inset:0;z-index:499;pointer-events:none;opacity:0;transition:opacity .4s}
#heat.on{opacity:1}

/* COMPASS */
#compass{position:fixed;bottom:200px;right:16px;z-index:1000;width:48px;height:48px;transition:transform .3s}
#compass svg{width:100%;height:100%;filter:drop-shadow(0 2px 6px rgba(0,0,0,.5))}

/* TOP BAR */
#top{position:fixed;top:0;left:0;right:0;padding:12px 16px;padding-top:max(12px,env(safe-area-inset-top));display:flex;justify-content:space-between;align-items:flex-start;z-index:1000;background:linear-gradient(to bottom,rgba(10,14,23,.92),rgba(10,14,23,.4) 70%,transparent);pointer-events:none}
#top>*{pointer-events:all}
.title{font-family:'Cormorant Garamond',serif;font-size:18px;font-weight:300;letter-spacing:4px;text-transform:uppercase;padding-top:4px}
.tr{display:flex;gap:6px;align-items:center;flex-wrap:wrap;justify-content:flex-end;max-width:70%}
.ib{width:36px;height:36px;border-radius:50%;background:var(--card);border:1px solid var(--bdr);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:.3s;color:var(--t2);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);flex-shrink:0}
.ib:hover,.ib.active{border-color:var(--accent);color:var(--accent)}
.ib svg{width:15px;height:15px}
.badge{display:flex;align-items:center;gap:5px;padding:4px 10px;border-radius:16px;background:var(--card);border:1px solid var(--bdr);font-size:10px;letter-spacing:1px;text-transform:uppercase;color:var(--t2);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);white-space:nowrap}
.badge .dot{width:6px;height:6px;border-radius:50%;background:var(--t3);transition:.4s}
.badge.searching .dot{background:#e8b44a;animation:blink 1s infinite}
.badge.locked .dot{background:var(--accent);box-shadow:0 0 6px var(--glow)}
.badge.locked{color:var(--accent)}
.badge.error .dot{background:#e05555}
.badge.error{color:#e05555}
@keyframes blink{50%{opacity:.3}}
.mode-badge{display:none;background:var(--card);border:1px solid var(--bdr);color:var(--accent);padding:4px 10px;border-radius:16px;font-size:10px;letter-spacing:1px;backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px)}
.mode-badge.on{display:flex;align-items:center;gap:4px}
.fire{font-size:11px}

/* STATS */
#stats{position:fixed;bottom:0;left:0;right:0;z-index:1000;padding:0 12px;padding-bottom:max(12px,env(safe-area-inset-bottom));pointer-events:none}
.sc{background:var(--card);border:1px solid var(--bdr);border-radius:var(--r);padding:14px 16px;pointer-events:all;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px)}
.sr{display:flex;margin-bottom:10px}
.sb{text-align:center;flex:1}
.sb+.sb{border-left:1px solid var(--bdr)}
.sv{font-family:'Cormorant Garamond',serif;font-size:24px;font-weight:300;color:var(--accent);line-height:1;margin-bottom:2px}
.sl{font-size:8px;letter-spacing:1.5px;text-transform:uppercase;color:var(--t2)}
.pb{height:3px;background:rgba(110,196,168,.08);border-radius:2px;overflow:hidden;margin-bottom:8px}
.pf{height:100%;background:linear-gradient(90deg,var(--adim),var(--accent));border-radius:2px;transition:width .6s}
.dr{display:flex;align-items:center;gap:8px;font-size:9px;color:var(--t3);letter-spacing:1px;text-transform:uppercase}
.db{flex:1;height:3px;background:rgba(110,196,168,.08);border-radius:2px;overflow:hidden}
.df{height:100%;background:linear-gradient(90deg,#e8b44a,var(--accent));border-radius:2px;transition:width .5s}

/* MILESTONE */
#ms{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(.9);z-index:2000;background:rgba(17,24,39,.96);border:1px solid var(--accent);border-radius:var(--r);padding:28px 40px;text-align:center;opacity:0;visibility:hidden;transition:.5s cubic-bezier(.22,1,.36,1);box-shadow:0 0 60px rgba(110,196,168,.2);backdrop-filter:blur(20px)}
#ms.show{opacity:1;visibility:visible;transform:translate(-50%,-50%) scale(1)}
#ms h3{font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:300;color:var(--accent);margin-bottom:6px}
#ms p{font-size:12px;color:var(--t2)}

/* PHOTO */
#pmod{position:fixed;inset:0;z-index:3000;background:rgba(10,14,23,.85);display:none;align-items:center;justify-content:center;backdrop-filter:blur(8px)}
#pmod.show{display:flex}
.pmi{background:var(--card);border:1px solid var(--bdr);border-radius:var(--r);padding:24px;max-width:300px;width:90%;text-align:center}
.pmi h3{font-family:'Cormorant Garamond',serif;font-size:18px;font-weight:300;color:var(--accent);margin-bottom:14px}
.pia{border:2px dashed var(--bdr);border-radius:10px;padding:20px;margin-bottom:12px;cursor:pointer;position:relative;overflow:hidden}
.pia img{max-width:100%;max-height:180px;border-radius:6px;display:none}
.pia p{font-size:11px;color:var(--t3)}
.pia input{position:absolute;inset:0;opacity:0;cursor:pointer}
.pn{width:100%;background:rgba(255,255,255,.05);border:1px solid var(--bdr);border-radius:8px;padding:8px 12px;color:var(--t1);font-family:inherit;font-size:12px;margin-bottom:12px;outline:none;resize:none}
.pn::placeholder{color:var(--t3)}
.pbs{display:flex;gap:8px}
.pbs button{flex:1;padding:8px;border-radius:8px;font-family:inherit;font-size:12px;font-weight:500;cursor:pointer;border:1px solid var(--bdr)}
.bc{background:0 0;color:var(--t2)}
.bs{background:var(--accent);color:var(--bg);border-color:var(--accent)!important}
.pm{width:28px;height:28px;border-radius:50%;border:2px solid var(--accent);overflow:hidden;box-shadow:0 0 10px rgba(110,196,168,.3);cursor:pointer;background:var(--bg)}
.pm img{width:100%;height:100%;object-fit:cover}
.user-marker-icon{background:none!important;border:none!important}
.coords{position:fixed;bottom:135px;left:12px;z-index:1000;font-size:9px;letter-spacing:1px;color:var(--t3);font-family:monospace}
@media(pointer:coarse){.dc{display:none!important}}
.dc{position:fixed;bottom:160px;right:16px;z-index:1000;display:flex;flex-direction:column;gap:4px;align-items:center}
.drow{display:flex;gap:4px}
.db2{width:36px;height:36px;border-radius:50%;background:var(--card);border:1px solid var(--bdr);color:var(--t2);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:13px;backdrop-filter:blur(12px)}
.db2:hover{border-color:var(--accent);color:var(--accent)}
.db2:active{transform:scale(.9)}
.dl{font-size:7px;letter-spacing:2px;text-transform:uppercase;color:var(--t3);margin-bottom:2px}
</style>
</head>
<body>
<div id="splash">
  <div class="logo-mark"><svg viewBox="0 0 24 24" fill="none" stroke="#6ec4a8" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20z"/><path d="M2 12h20"/></svg></div>
  <h1>Terra Incognita</h1>
  <p class="sub">Uncover your city</p>
  <button class="start-btn" onclick="startApp()">Begin Exploring</button>
  <div class="hint"><strong>üì± iPhone:</strong> Safari ‚Üí Share ‚¨Ü ‚Üí Add to Home Screen</div>
</div>

<div id="map"></div>
<canvas id="heat"></canvas>
<canvas id="fog"></canvas>

<!-- COMPASS -->
<div id="compass">
  <svg viewBox="0 0 48 48"><circle cx="24" cy="24" r="22" fill="rgba(17,24,39,.8)" stroke="rgba(110,196,168,.2)" stroke-width="1"/><polygon points="24,6 27,22 24,20 21,22" fill="#e05555" opacity=".9"/><polygon points="24,42 21,26 24,28 27,26" fill="rgba(255,255,255,.5)"/><circle cx="24" cy="24" r="2.5" fill="rgba(110,196,168,.6)"/><text x="24" y="5" text-anchor="middle" fill="rgba(255,255,255,.4)" font-size="5" font-family="DM Sans">N</text></svg>
</div>

<div id="top">
  <div class="title">Terra</div>
  <div class="tr">
    <div class="badge" id="streak"><span class="fire">üî•</span><span id="stxt">0</span></div>
    <div class="mode-badge" id="mbadge"><span id="mtxt">üö∂ 0 km/h</span></div>
    <div class="badge" id="gbadge"><div class="dot"></div><span id="gtxt">No GPS</span></div>
    <button class="ib" onclick="centerUser()" title="Center"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 2v4m0 12v4M2 12h4m12 0h4"/></svg></button>
    <button class="ib" id="hbtn" onclick="togHeat()" title="Heatmap"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/><path d="M12 6v6l4 2"/></svg></button>
    <button class="ib" onclick="openPhoto()" title="Photo"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg></button>
    <button class="ib" onclick="exportMap()" title="Export"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></button>
    <button class="ib" onclick="doReset()" title="Reset"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg></button>
  </div>
</div>

<div id="stats"><div class="sc">
  <div class="sr">
    <div class="sb"><div class="sv" id="vTiles">0</div><div class="sl">Tiles</div></div>
    <div class="sb"><div class="sv" id="vPct">0%</div><div class="sl">Explored</div></div>
    <div class="sb"><div class="sv" id="vDist">0</div><div class="sl">Km</div></div>
    <div class="sb"><div class="sv" id="vAcc">‚Äî</div><div class="sl">GPS ¬±m</div></div>
  </div>
  <div class="pb"><div class="pf" id="prog" style="width:0%"></div></div>
  <div class="dr"><span>Daily</span><div class="db"><div class="df" id="dfill" style="width:0%"></div></div><span id="dcnt">0/50</span></div>
</div></div>

<div class="coords" id="coords">‚Äî</div>

<div class="dc">
  <div class="dl">Simulate</div>
  <button class="db2" onclick="sim(0,-1)">‚Üë</button>
  <div class="drow"><button class="db2" onclick="sim(-1,0)">‚Üê</button><button class="db2" onclick="sim(1,0)">‚Üí</button></div>
  <button class="db2" onclick="sim(0,1)">‚Üì</button>
</div>

<div id="ms"><h3 id="msT"></h3><p id="msP"></p></div>

<div id="pmod">
  <div class="pmi">
    <h3>üìç Drop a Photo</h3>
    <div class="pia" onclick="$('pfile').click()"><img id="pprev"/><p id="pph">Tap to take a photo</p><input type="file" id="pfile" accept="image/*" capture="environment" onchange="prevPhoto(this)"/></div>
    <textarea class="pn" id="pnote" placeholder="Add a note..." rows="2"></textarea>
    <div class="pbs"><button class="bc" onclick="closePhoto()">Cancel</button><button class="bs" onclick="savePhoto()">Drop It</button></div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TERRA INCOGNITA v5
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const TILE_DEG=0.00025, GRID_R=150, TOTAL=(GRID_R*2+1)**2, DAILY_GOAL=50;
const MIN_MOVE=3, MAX_JUMP=0.5, SK='terra_v5';

const MODES={
  walk:{icon:'üö∂',min:0,max:8,radius:40,zoom:17},
  bike:{icon:'üö¥',min:8,max:25,radius:80,zoom:15},
  car:{icon:'üöó',min:25,max:999,radius:200,zoom:14}
};

let map,fogC,fogX,heatC,heatX,cloudPat;
let uLat=null,uLng=null,oLat=null,oLng=null;
let revealed=new Set(),vc={},dist=0;
let lastP=null,lastT=null,spd=0,mode='walk';
let msD=new Set(),uMark=null,accC=null,on=false;
let trail=null,trailPts=[];
let photos=[],pMarks=[],heatOn=false;
let streak={cur:0,last:null,today:0};
let pending=[];
const $=id=>document.getElementById(id);

// HAPTIC
function hap(s='light'){if(navigator.vibrate)navigator.vibrate(s==='heavy'?[30,10,30]:15)}

// ‚îÄ‚îÄ MAP (with OpenStreetMap infrastructure layer) ‚îÄ‚îÄ
function initMap(lat,lng){
  const z=MODES[mode].zoom;
  map=L.map('map',{center:[lat,lng],zoom:z,zoomControl:false,attributionControl:false,maxZoom:19,minZoom:11});

  // Layer 1: Satellite imagery
  const sat=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:19});

  // Layer 2: OpenStreetMap roads/labels/bike routes overlay (transparent)
  const roads=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom:19,opacity:0.35
  });

  // Layer 3: OpenCycleMap for bike infrastructure (if available, fallback to OSM)
  const infra=L.tileLayer('https://tile.thunderforest.com/transport/{z}/{x}/{y}.png?apikey=6170aad10dfd42a38d4d8c709a536f38',{
    maxZoom:19,opacity:0.25
  });

  sat.addTo(map);
  roads.addTo(map);

  // User marker
  const svg=`<svg width="32" height="32" viewBox="0 0 32 32"><circle cx="16" cy="16" r="14" fill="none" stroke="rgba(110,196,168,.3)" stroke-width="2"><animate attributeName="r" values="8;14;8" dur="2.5s" repeatCount="indefinite"/><animate attributeName="opacity" values=".6;.1;.6" dur="2.5s" repeatCount="indefinite"/></circle><circle cx="16" cy="16" r="6" fill="#6ec4a8" stroke="#fff" stroke-width="2.5"/></svg>`;
  uMark=L.marker([lat,lng],{icon:L.divIcon({html:svg,className:'user-marker-icon',iconSize:[32,32],iconAnchor:[16,16]}),zIndexOffset:1000}).addTo(map);
  accC=L.circle([lat,lng],{radius:30,color:'rgba(110,196,168,.2)',fillColor:'rgba(110,196,168,.05)',weight:1,interactive:false}).addTo(map);

  // Trail
  trail=L.polyline([],{color:'#6ec4a8',weight:3,opacity:0.5,smoothFactor:1,dashArray:'8,6'}).addTo(map);

  fogC=$('fog'); fogX=fogC.getContext('2d');
  heatC=$('heat'); heatX=heatC.getContext('2d');
  rzFog(); mkCloud();

  map.on('move zoom moveend zoomend resize',drawFog);
  map.on('move zoom moveend zoomend resize',()=>{if(heatOn)drawHeat()});
  window.addEventListener('resize',()=>{rzFog();drawFog()});

  photos.forEach(p=>addPMark(p));
  revealAt(lat,lng); drawFog(); updateStreak();
}

function rzFog(){fogC.width=heatC.width=innerWidth;fogC.height=heatC.height=innerHeight}

// ‚îÄ‚îÄ CLOUD TEXTURE (seamless perlin) ‚îÄ‚îÄ
function mkCloud(){
  const S=512,c=document.createElement('canvas');c.width=c.height=S;
  const cx=c.getContext('2d'),d=cx.createImageData(S,S);
  let _s=42;const rng=()=>{_s=(_s*16807)%2147483647;return(_s-1)/2147483646};
  const P=[];for(let i=0;i<256;i++)P[i]=i;
  for(let i=255;i>0;i--){const j=Math.floor(rng()*(i+1));[P[i],P[j]]=[P[j],P[i]]}
  for(let i=0;i<256;i++)P[i+256]=P[i];
  const fd=t=>t*t*t*(t*(t*6-15)+10);
  const lp=(a,b,t)=>a+t*(b-a);
  const gr=(h,x,y)=>{const v=h&3;return((v&1)?-x:x)+((v&2)?-y:y)};
  const pn=(x,y)=>{const xi=Math.floor(x)&255,yi=Math.floor(y)&255,xf=x-Math.floor(x),yf=y-Math.floor(y),u=fd(xf),v=fd(yf);return lp(lp(gr(P[P[xi]+yi],xf,yf),gr(P[P[xi+1]+yi],xf-1,yf),u),lp(gr(P[P[xi]+yi+1],xf,yf-1),gr(P[P[xi+1]+yi+1],xf-1,yf-1),u),v)};

  for(let y=0;y<S;y++)for(let x=0;x<S;x++){
    let v=pn(x/64,y/64)*.5+pn(x/32,y/32)*.25+pn(x/16,y/16)*.12+pn(x/8,y/8)*.06;
    v=(v+1)*.5;v=Math.pow(Math.min(1,Math.max(0,v)),0.75);
    const i=(y*S+x)*4,l=190+v*65;
    d.data[i]=l;d.data[i+1]=l+2;d.data[i+2]=l+8;d.data[i+3]=Math.floor(150+v*100);
  }
  cx.putImageData(d,0,0);
  cloudPat=fogX.createPattern(c,'repeat');
}

// ‚îÄ‚îÄ GRID ‚îÄ‚îÄ
function g2g(lat,lng){return[Math.floor((lng-oLng)/TILE_DEG),Math.floor((oLat-lat)/TILE_DEG)]}
function g2ll(gx,gy){return[oLat-gy*TILE_DEG,oLng+gx*TILE_DEG]}

// ‚îÄ‚îÄ REVEAL ‚Äî perfect circle in meters ‚îÄ‚îÄ
function revealAt(lat,lng){
  const rM=MODES[mode].radius;
  const rDeg=rM/111000;
  const rT=Math.ceil(rDeg/TILE_DEG);
  const[cx,cy]=g2g(lat,lng);
  let n=0;
  for(let dx=-rT;dx<=rT;dx++)for(let dy=-rT;dy<=rT;dy++){
    if(dx*dx+dy*dy>rT*rT)continue;
    const k=`${cx+dx},${cy+dy}`;
    vc[k]=(vc[k]||0)+1;
    if(!revealed.has(k)){revealed.add(k);n++;pending.push(k)}
  }
  if(n>0){hap(n>15?'heavy':'light');drawFog();updateStats();checkMS();updateDaily(n);saveState()}
}

// ‚îÄ‚îÄ FOG ‚Äî clean circle + revealed tiles ‚îÄ‚îÄ
function drawFog(){
  if(!map||!fogX)return;
  const w=fogC.width,h=fogC.height;
  fogX.clearRect(0,0,w,h);

  // 1. Cloud fill
  fogX.save();
  fogX.globalAlpha=0.9;
  fogX.fillStyle=cloudPat||'rgba(200,210,220,.9)';
  fogX.fillRect(0,0,w,h);
  fogX.globalAlpha=0.15;
  fogX.fillStyle='rgba(200,210,225,1)';
  fogX.fillRect(0,0,w,h);
  fogX.globalAlpha=1;

  // 2. Cut revealed areas
  fogX.globalCompositeOperation='destination-out';

  // A. Perfect circle around user (live visibility)
  if(uLat!==null){
    const pt=map.latLngToContainerPoint([uLat,uLng]);
    const rM=MODES[mode].radius;
    // Convert meters to pixels
    const pt2=map.latLngToContainerPoint([uLat+rM/111000,uLng]);
    const rPx=Math.abs(pt.y-pt2.y);

    const g=fogX.createRadialGradient(pt.x,pt.y,rPx*0.7,pt.x,pt.y,rPx*1.3);
    g.addColorStop(0,'rgba(0,0,0,1)');
    g.addColorStop(0.6,'rgba(0,0,0,1)');
    g.addColorStop(0.85,'rgba(0,0,0,0.5)');
    g.addColorStop(1,'rgba(0,0,0,0)');
    fogX.fillStyle=g;
    fogX.beginPath();
    fogX.arc(pt.x,pt.y,rPx*1.3,0,Math.PI*2);
    fogX.fill();
  }

  // B. Previously explored tiles ‚Äî batch render as rects (fast)
  //    Then blur the mask for soft edges
  const mC=document.createElement('canvas');mC.width=w;mC.height=h;
  const mX=mC.getContext('2d');

  revealed.forEach(k=>{
    const[gx,gy]=k.split(',').map(Number);
    const[la1,lo1]=g2ll(gx,gy),[la2,lo2]=g2ll(gx+1,gy+1);
    const p1=map.latLngToContainerPoint([la1,lo1]),p2=map.latLngToContainerPoint([la2,lo2]);
    const x=Math.min(p1.x,p2.x),y=Math.min(p1.y,p2.y);
    const tw=Math.abs(p2.x-p1.x)+1,th=Math.abs(p2.y-p1.y)+1;
    mX.fillStyle='#000';
    mX.fillRect(x,y,tw,th);
  });

  // Blur the tile mask for soft edges
  fogX.filter='blur(12px)';
  fogX.drawImage(mC,0,0);
  fogX.filter='none';
  // Draw again sharp on top for solid interior
  fogX.globalAlpha=0.7;
  fogX.drawImage(mC,0,0);
  fogX.globalAlpha=1;

  fogX.restore();
}

// ‚îÄ‚îÄ HEATMAP ‚îÄ‚îÄ
function togHeat(){heatOn=!heatOn;$('hbtn').classList.toggle('active',heatOn);heatOn?($('heat').classList.add('on'),drawHeat()):$('heat').classList.remove('on')}
function drawHeat(){
  if(!map||!heatX)return;
  const w=heatC.width,h=heatC.height;heatX.clearRect(0,0,w,h);
  const mx=Math.max(1,...Object.values(vc));
  for(const[k,v]of Object.entries(vc)){
    const[gx,gy]=k.split(',').map(Number);
    const[la1,lo1]=g2ll(gx,gy),[la2,lo2]=g2ll(gx+1,gy+1);
    const p1=map.latLngToContainerPoint([la1,lo1]),p2=map.latLngToContainerPoint([la2,lo2]);
    const r=v/mx;
    const cl=r<.25?'42,90,74':r<.5?'110,196,168':r<.75?'232,180,74':'224,112,80';
    heatX.fillStyle=`rgba(${cl},${.15+r*.35})`;
    heatX.fillRect(Math.min(p1.x,p2.x),Math.min(p1.y,p2.y),Math.abs(p2.x-p1.x)+1,Math.abs(p2.y-p1.y)+1);
  }
}

// ‚îÄ‚îÄ TRAIL ‚îÄ‚îÄ
function addTrail(lat,lng){trailPts.push([lat,lng]);if(trailPts.length>5000)trailPts=trailPts.slice(-4000);if(trail)trail.setLatLngs(trailPts)}

// ‚îÄ‚îÄ GPS ‚îÄ‚îÄ
function startGPS(){
  if(!navigator.geolocation){setG('error','No GPS');fb();return}
  setG('searching','Searching‚Ä¶');
  navigator.geolocation.getCurrentPosition(p=>onFirst(p.coords),e=>{setG('error',e.code===1?'Denied':'Unavailable');fb()},{enableHighAccuracy:true,timeout:20000,maximumAge:0});
  navigator.geolocation.watchPosition(p=>onUpd(p.coords),()=>{},{enableHighAccuracy:true,maximumAge:2000,timeout:15000});
}
function fb(){if(!map){const la=oLat||25.6866,lo=oLng||-100.3161;oLat=oLat||la;oLng=oLng||lo;uLat=la;uLng=lo;initMap(la,lo);updateStats()}}

function onFirst(c){
  uLat=c.latitude;uLng=c.longitude;
  if(!oLat){oLat=c.latitude;oLng=c.longitude}
  setG('locked',`¬±${Math.round(c.accuracy)}m`);
  $('vAcc').textContent=Math.round(c.accuracy);
  showC(c.latitude,c.longitude);
  if(!map){initMap(c.latitude,c.longitude);updateStats()}else map.setView([c.latitude,c.longitude],MODES[mode].zoom);
  addTrail(c.latitude,c.longitude);revealAt(c.latitude,c.longitude);
}

function onUpd(c){
  const lat=c.latitude,lng=c.longitude,acc=c.accuracy;
  setG('locked',`¬±${Math.round(acc)}m`);$('vAcc').textContent=Math.round(acc);
  showC(lat,lng);
  if(uMark)uMark.setLatLng([lat,lng]);
  if(accC){accC.setLatLng([lat,lng]);accC.setRadius(acc)}

  // Update compass from heading if available
  if(c.heading && !isNaN(c.heading)){
    $('compass').style.transform=`rotate(${-c.heading}deg)`;
  }

  const now=Date.now();
  if(lastP&&lastT){
    const d=hav(lastP.lat,lastP.lng,lat,lng),dtH=(now-lastT)/3600000;
    if(dtH>0){spd=d/dtH;setMode(spd)}
    if(d*1000>MIN_MOVE&&d<MAX_JUMP){
      dist+=d;uLat=lat;uLng=lng;lastP={lat,lng};lastT=now;
      addTrail(lat,lng);revealAt(lat,lng);return;
    }
  }
  if(!lastP||hav(lastP.lat,lastP.lng,lat,lng)*1000>MIN_MOVE){
    lastP={lat,lng};lastT=now;uLat=lat;uLng=lng;addTrail(lat,lng);revealAt(lat,lng);
  }
}

function hav(a,b,c,d){const R=6371,dA=(c-a)*Math.PI/180,dO=(d-b)*Math.PI/180;const x=Math.sin(dA/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dO/2)**2;return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x))}

function setG(s,t){$('gbadge').className='badge '+s;$('gtxt').textContent=t}
function showC(la,lo){$('coords').textContent=`${Math.abs(la).toFixed(5)}¬∞${la>=0?'N':'S'}  ${Math.abs(lo).toFixed(5)}¬∞${lo>=0?'E':'W'}`}

function setMode(kmh){
  const prev=mode;
  if(kmh>=MODES.car.min) mode='car';
  else if(kmh>=MODES.bike.min) mode='bike';
  else mode='walk';

  const m=MODES[mode];
  if(kmh>2){
    $('mbadge').classList.add('on');
    $('mtxt').textContent=`${m.icon} ${Math.round(kmh)} km/h`;
  }else $('mbadge').classList.remove('on');

  // Auto-zoom when mode changes
  if(prev!==mode&&map){
    map.flyTo([uLat,uLng],m.zoom,{duration:0.8});
    drawFog();
  }
}

function centerUser(){if(uLat&&map)map.flyTo([uLat,uLng],MODES[mode].zoom,{duration:.5})}

// ‚îÄ‚îÄ SIMULATE ‚îÄ‚îÄ
function sim(dx,dy){
  const s=TILE_DEG*1.8;
  const la=(uLat||oLat)-dy*s,lo=(uLng||oLng)+dx*s;
  dist+=hav(uLat||oLat,uLng||oLng,la,lo);
  uLat=la;uLng=lo;lastP={lat:la,lng:lo};lastT=Date.now();
  if(uMark)uMark.setLatLng([la,lo]);if(accC)accC.setLatLng([la,lo]);
  map.panTo([la,lo]);addTrail(la,lo);revealAt(la,lo);showC(la,lo);
}
document.addEventListener('keydown',e=>{if(!on)return;const m={ArrowUp:[0,-1],w:[0,-1],ArrowDown:[0,1],s:[0,1],ArrowRight:[1,0],d:[1,0],ArrowLeft:[-1,0],a:[-1,0]};if(m[e.key]){sim(...m[e.key]);e.preventDefault()}});

// ‚îÄ‚îÄ STATS ‚îÄ‚îÄ
function updateStats(){const n=revealed.size,p=n/TOTAL*100;$('vTiles').textContent=n;$('vPct').textContent=p.toFixed(1)+'%';$('vDist').textContent=dist.toFixed(2);$('prog').style.width=Math.min(p*10,100)+'%'}

// ‚îÄ‚îÄ DAILY/STREAK ‚îÄ‚îÄ
function today(){return new Date().toISOString().slice(0,10)}
function yest(){const d=new Date();d.setDate(d.getDate()-1);return d.toISOString().slice(0,10)}
function updateDaily(n){
  const t=today();
  if(streak.last!==t){
    if(streak.last===yest()&&streak.today>=DAILY_GOAL)streak.cur++;
    else if(streak.last!==yest())streak.cur=0;
    streak.today=0;streak.last=t;
  }
  streak.today+=n;
  if(streak.today>=DAILY_GOAL&&streak.today-n<DAILY_GOAL){streak.cur++;hap('heavy');showMilestone('Daily Goal! üî•','Streak continues')}
  $('dfill').style.width=Math.min(streak.today/DAILY_GOAL*100,100)+'%';
  $('dcnt').textContent=`${Math.min(streak.today,DAILY_GOAL)}/${DAILY_GOAL}`;
  updateStreak();
}
function updateStreak(){$('stxt').textContent=streak.cur}

// ‚îÄ‚îÄ MILESTONES ‚îÄ‚îÄ
function checkMS(){
  const p=revealed.size/TOTAL*100;
  const ms=[[.02,'First Steps'],[.05,'Curious'],[.1,'Wanderer'],[.25,'Pathfinder'],[.5,'Scout'],[1,'Explorer'],[2,'Adventurer'],[5,'Cartographer'],[10,'Wayfinder'],[25,'Quarter Master'],[50,'Half the World'],[75,'Almost There'],[100,'Terra Cognita']];
  for(const[m,nm]of ms)if(p>=m&&!msD.has(m)){msD.add(m);showMilestone(nm,m>=1?`${m}% explored`:`${revealed.size} tiles`);break}
}
function showMilestone(t,s){$('msT').textContent=t;$('msP').textContent=s;$('ms').classList.add('show');hap('heavy');setTimeout(()=>$('ms').classList.remove('show'),2800)}

// ‚îÄ‚îÄ PHOTOS ‚îÄ‚îÄ
let pendPh=null;
function openPhoto(){$('pmod').classList.add('show');$('pprev').style.display='none';$('pph').style.display='';$('pnote').value='';pendPh=null}
function closePhoto(){$('pmod').classList.remove('show')}
function prevPhoto(i){if(!i.files||!i.files[0])return;const r=new FileReader();r.onload=e=>{$('pprev').src=e.target.result;$('pprev').style.display='block';$('pph').style.display='none';pendPh=e.target.result};r.readAsDataURL(i.files[0])}
function savePhoto(){if(!pendPh||!uLat)return;const d={id:Date.now(),lat:uLat,lng:uLng,img:pendPh,note:$('pnote').value,date:new Date().toLocaleDateString()};photos.push(d);addPMark(d);closePhoto();hap('heavy');saveState()}
function addPMark(d){if(!map)return;const m=L.marker([d.lat,d.lng],{icon:L.divIcon({html:`<div class="pm"><img src="${d.img}"/></div>`,className:'',iconSize:[28,28],iconAnchor:[14,14]}),zIndexOffset:500}).addTo(map);m.bindPopup(`<div style="text-align:center;max-width:180px"><img src="${d.img}" style="width:100%;border-radius:6px;margin-bottom:6px"/><p style="font-size:11px;margin:0">${d.note||''}</p><small style="color:#888">${d.date}</small></div>`);pMarks.push(m)}

// ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ
function exportMap(){const l=document.createElement('a'),c=document.createElement('canvas'),w=innerWidth,h=innerHeight;c.width=w;c.height=h;const x=c.getContext('2d');x.fillStyle='#0a0e17';x.fillRect(0,0,w,h);x.drawImage(fogC,0,0);x.fillStyle='rgba(10,14,23,.7)';x.fillRect(0,h-70,w,70);x.font='300 24px Cormorant Garamond,serif';x.fillStyle='#6ec4a8';x.textAlign='center';x.fillText(`${revealed.size} tiles ¬∑ ${(revealed.size/TOTAL*100).toFixed(1)}% ¬∑ ${dist.toFixed(1)}km`,w/2,h-35);x.font='11px DM Sans,sans-serif';x.fillStyle='#7a8a82';x.fillText('Terra Incognita',w/2,h-12);l.download=`terra-${today()}.png`;l.href=c.toDataURL('image/png');l.click();hap()}

// ‚îÄ‚îÄ SAVE/LOAD ‚îÄ‚îÄ
function saveState(){try{localStorage.setItem(SK,JSON.stringify({t:Array.from(revealed),vc,oLa:oLat,oLo:oLng,uLa:uLat,uLo:uLng,d:dist,m:Array.from(msD),tr:trailPts.slice(-2000),ph:photos.slice(-50),sk:streak}))}catch(e){try{localStorage.setItem(SK,JSON.stringify({t:Array.from(revealed),vc,oLa:oLat,oLo:oLng,uLa:uLat,uLo:uLng,d:dist,m:Array.from(msD),sk:streak}))}catch(e2){}}}
function loadState(){try{const r=localStorage.getItem(SK);if(!r)return false;const s=JSON.parse(r);if(!s.oLa||!s.t?.length)return false;oLat=s.oLa;oLng=s.oLo;revealed=new Set(s.t);vc=s.vc||{};dist=s.d||0;msD=new Set(s.m||[]);trailPts=s.tr||[];photos=s.ph||[];streak=s.sk||{cur:0,last:null,today:0};if(s.uLa){uLat=s.uLa;uLng=s.uLo}return true}catch(e){return false}}
function doReset(){if(confirm('Reset ALL progress?')){localStorage.removeItem(SK);revealed=new Set();vc={};dist=0;msD=new Set();trailPts=[];photos=[];pMarks.forEach(m=>map.removeLayer(m));pMarks=[];streak={cur:0,last:null,today:0};if(trail)trail.setLatLngs([]);oLat=uLat;oLng=uLng;drawFog();updateStats();updateStreak();$('dfill').style.width='0%';$('dcnt').textContent=`0/${DAILY_GOAL}`;if(uLat)revealAt(uLat,uLng)}}

// ‚îÄ‚îÄ START ‚îÄ‚îÄ
function startApp(){on=true;$('splash').classList.add('hidden');const h=loadState();startGPS();if(h&&!map){initMap(uLat||oLat,uLng||oLng);updateStats();if(trail&&trailPts.length)trail.setLatLngs(trailPts);$('dfill').style.width=Math.min(streak.today/DAILY_GOAL*100,100)+'%';$('dcnt').textContent=`${Math.min(streak.today,DAILY_GOAL)}/${DAILY_GOAL}`}}
</script>
</body>
</html>
