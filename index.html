<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Terra">
<meta name="theme-color" content="#0a0e17">
<title>Terra Incognita</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<style>
:root{--bg:#0a0e17;--card:rgba(17,24,39,.93);--accent:#6ec4a8;--adim:#3a7d66;--glow:rgba(110,196,168,.4);--t1:#e8ece9;--t2:#7a8a82;--t3:#4a5a52;--bdr:rgba(110,196,168,.12);--r:14px;--warn:#e8b44a;--hot:#e07050}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;width:100%;overflow:hidden;font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--t1);-webkit-font-smoothing:antialiased;touch-action:none}
button{font-family:inherit}

/* SPLASH */
#splash{position:fixed;inset:0;z-index:2000;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity .8s,visibility .8s}
#splash.hidden{opacity:0;visibility:hidden;pointer-events:none}
.logo-mark{width:72px;height:72px;border-radius:50%;border:2px solid var(--accent);display:flex;align-items:center;justify-content:center;margin-bottom:28px;animation:pulse 2.5s ease-in-out infinite}
@keyframes pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.05);opacity:.7}}
.logo-mark svg{width:32px;height:32px}
#splash h1{font-family:'Cormorant Garamond',serif;font-size:28px;font-weight:300;letter-spacing:6px;text-transform:uppercase;margin-bottom:6px}
#splash .sub{font-size:12px;color:var(--t2);letter-spacing:3px;text-transform:uppercase;margin-bottom:40px}
.start-btn{background:0 0;border:1px solid var(--accent);color:var(--accent);padding:12px 44px;border-radius:40px;font-size:13px;font-weight:500;letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:.3s}
.start-btn:hover{background:var(--accent);color:var(--bg)}
.hint{margin-top:28px;max-width:280px;text-align:center;font-size:10px;color:var(--t3);line-height:1.7;opacity:0;animation:fadeIn 1s 1.5s forwards}
.hint b{color:var(--t2)}
@keyframes fadeIn{to{opacity:1}}

/* SETUP MODAL */
#setup{position:fixed;inset:0;z-index:2500;background:var(--bg);display:none;align-items:center;justify-content:center}
#setup.show{display:flex}
.setup-inner{max-width:300px;width:90%;text-align:center}
.setup-inner h2{font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:300;color:var(--accent);margin-bottom:20px}
.setup-inner p{font-size:11px;color:var(--t2);margin-bottom:16px}
.sf{display:flex;flex-direction:column;gap:12px;margin-bottom:20px}
.sf label{font-size:10px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);text-align:left}
.sf select,.sf input{background:rgba(255,255,255,.05);border:1px solid var(--bdr);border-radius:10px;padding:10px 14px;color:var(--t1);font-family:inherit;font-size:13px;outline:none;width:100%}
.sf select option{background:var(--bg)}
.sf .row2{display:flex;gap:8px}
.sf .row2>*{flex:1}
.sdone{background:var(--accent);color:var(--bg);border:none;padding:12px 40px;border-radius:40px;font-size:13px;font-weight:500;letter-spacing:2px;text-transform:uppercase;cursor:pointer}

/* MAP */
#map{position:absolute;inset:0;z-index:1;background:var(--bg)}
.leaflet-control-attribution,.leaflet-control-zoom{display:none!important}
#fog{position:absolute;inset:0;z-index:500;pointer-events:none;transition:opacity .5s}
#fog.lifted{opacity:.08!important}
#heat{position:absolute;inset:0;z-index:499;pointer-events:none;opacity:0;transition:opacity .4s}
#heat.on{opacity:1}

/* COMPASS ‚Äî top right, always visible */
#compass{position:fixed;top:max(12px,env(safe-area-inset-top));right:12px;z-index:1001;width:32px;height:32px;pointer-events:none}
#compass svg{width:100%;height:100%;filter:drop-shadow(0 1px 3px rgba(0,0,0,.5))}

/* TOP BAR */
#top{position:fixed;top:0;left:0;right:0;padding:10px 12px;padding-top:max(10px,env(safe-area-inset-top));display:flex;justify-content:space-between;align-items:flex-start;z-index:1000;background:linear-gradient(to bottom,rgba(10,14,23,.92),rgba(10,14,23,.4) 70%,transparent);pointer-events:none}
#top>*{pointer-events:all}
.title{font-family:'Cormorant Garamond',serif;font-size:16px;font-weight:300;letter-spacing:4px;text-transform:uppercase;padding-top:2px}
.tr{display:flex;gap:5px;align-items:center;flex-wrap:wrap;justify-content:flex-end;max-width:72%}
.ib{width:34px;height:34px;border-radius:50%;background:var(--card);border:1px solid var(--bdr);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:.3s;color:var(--t2);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);flex-shrink:0}
.ib:hover,.ib.active{border-color:var(--accent);color:var(--accent)}
.ib svg{width:14px;height:14px}
.badge{display:flex;align-items:center;gap:4px;padding:3px 8px;border-radius:14px;background:var(--card);border:1px solid var(--bdr);font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--t2);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);white-space:nowrap}
.badge .dot{width:5px;height:5px;border-radius:50%;background:var(--t3);transition:.4s}
.badge.searching .dot{background:var(--warn);animation:blink 1s infinite}
.badge.locked .dot{background:var(--accent);box-shadow:0 0 6px var(--glow)}
.badge.locked{color:var(--accent)}
.badge.error .dot{background:#e05555}
.badge.error{color:#e05555}
@keyframes blink{50%{opacity:.3}}
.mbadge{display:none;background:var(--card);border:1px solid var(--bdr);color:var(--accent);padding:3px 8px;border-radius:14px;font-size:9px;letter-spacing:1px;backdrop-filter:blur(12px)}
.mbadge.on{display:flex;align-items:center;gap:3px}

/* STATS */
#stats{position:fixed;bottom:0;left:0;right:0;z-index:1000;padding:0 10px;padding-bottom:max(10px,env(safe-area-inset-bottom));pointer-events:none}
.sc{background:var(--card);border:1px solid var(--bdr);border-radius:var(--r);padding:12px 14px;pointer-events:all;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px)}
.sr{display:flex;margin-bottom:8px}
.sb{text-align:center;flex:1}
.sb+.sb{border-left:1px solid var(--bdr)}
.sv{font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:300;color:var(--accent);line-height:1;margin-bottom:2px}
.sl{font-size:7px;letter-spacing:1.5px;text-transform:uppercase;color:var(--t2)}
.pb{height:3px;background:rgba(110,196,168,.08);border-radius:2px;overflow:hidden;margin-bottom:6px}
.pf{height:100%;background:linear-gradient(90deg,var(--adim),var(--accent));border-radius:2px;transition:width .6s}
.dr{display:flex;align-items:center;gap:6px;font-size:8px;color:var(--t3);letter-spacing:1px;text-transform:uppercase}
.dbar{flex:1;height:3px;background:rgba(110,196,168,.08);border-radius:2px;overflow:hidden}
.df{height:100%;background:linear-gradient(90deg,var(--warn),var(--accent));border-radius:2px;transition:width .5s}

/* MODE PICKER ‚Äî left side */
.mpick{position:fixed;left:10px;top:50%;transform:translateY(-50%);z-index:1000;display:flex;flex-direction:column;gap:5px;align-items:center}
.mp-btn{width:38px;height:38px;border-radius:50%;background:var(--card);border:1px solid var(--bdr);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;transition:.3s;backdrop-filter:blur(12px)}
.mp-btn:hover{border-color:var(--accent)}
.mp-btn.sel{border-color:var(--accent);box-shadow:0 0 14px rgba(110,196,168,.2)}
.mp-auto{font-size:7px;letter-spacing:1.5px;text-transform:uppercase;color:var(--t3);cursor:pointer;padding:3px 0;transition:.2s}
.mp-auto.active{color:var(--accent)}

/* MILESTONE */
#ms{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(.9);z-index:2000;background:rgba(17,24,39,.96);border:1px solid var(--accent);border-radius:var(--r);padding:24px 36px;text-align:center;opacity:0;visibility:hidden;transition:.5s cubic-bezier(.22,1,.36,1);box-shadow:0 0 60px rgba(110,196,168,.2);backdrop-filter:blur(20px)}
#ms.show{opacity:1;visibility:visible;transform:translate(-50%,-50%) scale(1)}
#ms h3{font-family:'Cormorant Garamond',serif;font-size:20px;font-weight:300;color:var(--accent);margin-bottom:4px}
#ms p{font-size:11px;color:var(--t2)}

/* PANELS (achievements, recap, etc) */
.panel{position:fixed;inset:0;z-index:3000;background:rgba(10,14,23,.92);display:none;overflow-y:auto;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)}
.panel.show{display:block}
.panel-inner{max-width:400px;margin:0 auto;padding:24px 20px;padding-top:max(24px,env(safe-area-inset-top))}
.panel-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.panel-head h2{font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:300;color:var(--accent)}
.panel-close{width:32px;height:32px;border-radius:50%;background:var(--card);border:1px solid var(--bdr);display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--t2);font-size:18px}

/* Achievements */
.ach-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.ach{background:var(--card);border:1px solid var(--bdr);border-radius:12px;padding:14px 8px;text-align:center;opacity:.35;transition:.3s}
.ach.earned{opacity:1;border-color:rgba(110,196,168,.3)}
.ach-icon{font-size:24px;margin-bottom:6px}
.ach-name{font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--t2);line-height:1.3}

/* Recap */
.recap-stat{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--bdr)}
.recap-stat:last-child{border:0}
.recap-label{font-size:11px;color:var(--t2)}
.recap-val{font-family:'Cormorant Garamond',serif;font-size:18px;color:var(--accent)}

/* Photo */
.pmod{position:fixed;inset:0;z-index:3000;background:rgba(10,14,23,.85);display:none;align-items:center;justify-content:center;backdrop-filter:blur(8px)}
.pmod.show{display:flex}
.pmi{background:var(--card);border:1px solid var(--bdr);border-radius:var(--r);padding:20px;max-width:280px;width:90%;text-align:center}
.pmi h3{font-family:'Cormorant Garamond',serif;font-size:16px;font-weight:300;color:var(--accent);margin-bottom:12px}
.pia{border:2px dashed var(--bdr);border-radius:10px;padding:16px;margin-bottom:10px;cursor:pointer;position:relative;overflow:hidden}
.pia img{max-width:100%;max-height:160px;border-radius:6px;display:none}
.pia p{font-size:10px;color:var(--t3)}
.pia input{position:absolute;inset:0;opacity:0;cursor:pointer}
.pn{width:100%;background:rgba(255,255,255,.05);border:1px solid var(--bdr);border-radius:8px;padding:8px 10px;color:var(--t1);font-family:inherit;font-size:11px;margin-bottom:10px;outline:none;resize:none}
.pn::placeholder{color:var(--t3)}
.pbs{display:flex;gap:6px}
.pbs button{flex:1;padding:8px;border-radius:8px;font-size:11px;font-weight:500;cursor:pointer;border:1px solid var(--bdr)}
.bc{background:0 0;color:var(--t2)}
.bs{background:var(--accent);color:var(--bg);border-color:var(--accent)!important}
.pm{width:26px;height:26px;border-radius:50%;border:2px solid var(--accent);overflow:hidden;box-shadow:0 0 8px rgba(110,196,168,.3);cursor:pointer;background:var(--bg)}
.pm img{width:100%;height:100%;object-fit:cover}
.user-marker-icon{background:none!important;border:none!important}
.coords{position:fixed;bottom:120px;left:10px;z-index:1000;font-size:8px;letter-spacing:1px;color:var(--t3);font-family:monospace}
@media(pointer:coarse){.dc{display:none!important}}
.dc{position:fixed;bottom:140px;right:12px;z-index:1000;display:flex;flex-direction:column;gap:3px;align-items:center}
.drow{display:flex;gap:3px}
.dbtn{width:34px;height:34px;border-radius:50%;background:var(--card);border:1px solid var(--bdr);color:var(--t2);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:12px;backdrop-filter:blur(12px)}
.dbtn:active{transform:scale(.9)}
.dlbl{font-size:7px;letter-spacing:2px;text-transform:uppercase;color:var(--t3);margin-bottom:1px}

/* Distance rings */
.dist-ring{fill:none;stroke:rgba(110,196,168,.15);stroke-width:1;stroke-dasharray:4,4}

/* TOOLS MENU ‚Äî slide-up panel */
#toolsMenu{position:fixed;bottom:0;left:0;right:0;z-index:2500;transform:translateY(100%);transition:transform .35s cubic-bezier(.22,1,.36,1);pointer-events:none}
#toolsMenu.show{transform:translateY(0);pointer-events:all}
.tm-bg{position:fixed;inset:0;background:rgba(10,14,23,.6);opacity:0;transition:opacity .3s;pointer-events:none}
#toolsMenu.show .tm-bg{opacity:1;pointer-events:all}
.tm-card{position:relative;z-index:1;background:var(--card);border-top:1px solid var(--bdr);border-radius:20px 20px 0 0;padding:20px 16px;padding-bottom:max(20px,env(safe-area-inset-bottom));backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);max-height:70vh;overflow-y:auto}
.tm-handle{width:40px;height:4px;border-radius:2px;background:rgba(255,255,255,.15);margin:0 auto 16px}
.tm-title{font-family:'Cormorant Garamond',serif;font-size:18px;font-weight:300;color:var(--accent);margin-bottom:14px;letter-spacing:2px}
.tm-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px}
.tm-item{display:flex;flex-direction:column;align-items:center;gap:6px;padding:12px 4px;border-radius:12px;background:rgba(255,255,255,.03);border:1px solid transparent;cursor:pointer;transition:.2s}
.tm-item:hover,.tm-item.active{border-color:var(--bdr);background:rgba(110,196,168,.06)}
.tm-item.active{border-color:rgba(110,196,168,.3)}
.tm-item svg{width:20px;height:20px;color:var(--t2)}
.tm-item.active svg{color:var(--accent)}
.tm-item span{font-size:8px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);text-align:center;line-height:1.2}
.tm-item.active span{color:var(--accent)}
.tm-section{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--t3);margin:12px 0 8px;padding-left:2px}
.tm-row{display:flex;gap:8px;margin-bottom:8px}
.tm-btn{flex:1;padding:10px;border-radius:10px;background:rgba(255,255,255,.03);border:1px solid var(--bdr);color:var(--t2);font-family:inherit;font-size:10px;letter-spacing:1px;text-transform:uppercase;cursor:pointer;text-align:center;transition:.2s}
.tm-btn:hover{border-color:var(--accent);color:var(--accent)}
.tm-btn.danger{border-color:rgba(224,80,80,.2);color:rgba(224,80,80,.6)}
.tm-btn.danger:hover{color:#e05050;border-color:rgba(224,80,80,.4)}
</style>
</head>
<body>
<!-- SPLASH -->
<div id="splash">
  <div class="logo-mark"><svg viewBox="0 0 24 24" fill="none" stroke="#6ec4a8" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20z"/><path d="M2 12h20"/></svg></div>
  <h1>Terra Incognita</h1>
  <p class="sub">Uncover your city</p>
  <button class="start-btn" onclick="showSetup()">Begin Exploring</button>
  <div class="hint"><b>üì± iPhone:</b> Safari ‚Üí Share ‚¨Ü ‚Üí Add to Home Screen</div>
</div>

<!-- SETUP ‚Äî calorie profile -->
<div id="setup">
  <div class="setup-inner">
    <h2>Quick Setup</h2>
    <p>For accurate calorie tracking (optional)</p>
    <div class="sf">
      <div>
        <label>Sex</label>
        <select id="s-sex"><option value="male">Male</option><option value="female">Female</option></select>
      </div>
      <div>
        <label>Weight</label>
        <div class="row2"><input id="s-wt" type="number" placeholder="kg" min="30" max="250"/></div>
      </div>
      <div>
        <label>Height</label>
        <div class="row2"><input id="s-ht" type="number" placeholder="cm" min="100" max="250"/></div>
      </div>
    </div>
    <button class="sdone" onclick="finishSetup()">Let's Go</button>
    <p style="margin-top:12px;font-size:9px;color:var(--t3);cursor:pointer" onclick="skipSetup()">Skip ‚Äî I'll set this later</p>
  </div>
</div>

<div id="map"></div>
<canvas id="heat"></canvas>
<canvas id="fog"></canvas>

<!-- COMPASS ‚Äî top center -->
<div id="compass">
  <svg viewBox="0 0 48 48"><circle cx="24" cy="24" r="22" fill="rgba(17,24,39,.85)" stroke="rgba(110,196,168,.2)" stroke-width="1"/><polygon points="24,6 27,22 24,20 21,22" fill="#e05555" opacity=".9"/><polygon points="24,42 21,26 24,28 27,26" fill="rgba(255,255,255,.4)"/><circle cx="24" cy="24" r="2" fill="rgba(110,196,168,.5)"/><text x="24" y="5" text-anchor="middle" fill="rgba(255,255,255,.35)" font-size="4.5" font-family="DM Sans">N</text></svg>
</div>

<!-- TOP BAR ‚Äî minimal -->
<div id="top">
  <div class="title">Terra</div>
  <div class="tr">
    <div class="badge" id="streak"><span style="font-size:10px">üî•</span><span id="stxt">0</span></div>
    <div class="mbadge" id="mbadge"><span id="mtxt">üö∂ 0</span></div>
    <div class="badge" id="gbadge"><div class="dot"></div><span id="gtxt">No GPS</span></div>
    <button class="ib" onclick="centerUser()" title="Center"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 2v4m0 12v4M2 12h4m12 0h4"/></svg></button>
    <button class="ib" id="plusbtn" onclick="togMenu()" title="More"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button>
  </div>
</div>

<!-- TOOLS MENU (slide-up) -->
<div id="toolsMenu">
  <div class="tm-bg" onclick="togMenu()"></div>
  <div class="tm-card">
    <div class="tm-handle"></div>
    <div class="tm-title">Tools</div>
    <div class="tm-grid">
      <div class="tm-item" id="ti-fog" onclick="togFogLift();updMenuState()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
        <span>Peek</span>
      </div>
      <div class="tm-item" id="ti-map" onclick="togMapStyle();updMenuState()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
        <span>Street Map</span>
      </div>
      <div class="tm-item" id="ti-ring" onclick="togRings();updMenuState()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
        <span>Rings</span>
      </div>
      <div class="tm-item" id="ti-heat" onclick="togHeat();updMenuState()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/><path d="M12 6v6l4 2"/></svg>
        <span>Heatmap</span>
      </div>
      <div class="tm-item" onclick="togMenu();openPhoto()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
        <span>Photo</span>
      </div>
      <div class="tm-item" onclick="togMenu();showAch()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 22V8a2 2 0 0 1 4 0v14"/></svg>
        <span>Awards</span>
      </div>
      <div class="tm-item" onclick="togMenu();showRecap()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M7 16l4-8 4 4 4-6"/></svg>
        <span>Recap</span>
      </div>
      <div class="tm-item" onclick="togMenu();exportMap()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        <span>Export</span>
      </div>
    </div>
    <div class="tm-section">Data</div>
    <div class="tm-row">
      <button class="tm-btn" onclick="backupData()">üíæ Backup</button>
      <button class="tm-btn" onclick="$('restoreFile').click()">üìÇ Restore</button>
      <input type="file" id="restoreFile" accept=".json" style="display:none" onchange="restoreData(this)"/>
    </div>
    <div class="tm-row" style="margin-top:8px">
      <button class="tm-btn danger" onclick="togMenu();doReset()">Reset All</button>
    </div>
  </div>
</div>

<!-- STATS -->
<div id="stats"><div class="sc">
  <div class="sr">
    <div class="sb"><div class="sv" id="vT">0</div><div class="sl">Tiles</div></div>
    <div class="sb"><div class="sv" id="vP">0%</div><div class="sl">Explored</div></div>
    <div class="sb"><div class="sv" id="vD">0</div><div class="sl">Km</div></div>
    <div class="sb"><div class="sv" id="vC">0</div><div class="sl">Cal</div></div>
  </div>
  <div class="pb"><div class="pf" id="prog" style="width:0%"></div></div>
  <div class="dr"><span>Daily</span><div class="dbar"><div class="df" id="dfill" style="width:0%"></div></div><span id="dcnt">0/50</span></div>
</div></div>

<div class="coords" id="coords">‚Äî</div>

<!-- MODE PICKER -->
<div class="mpick">
  <div class="mp-auto active" id="autolab" onclick="togAuto()">AUTO</div>
  <button class="mp-btn sel" id="mp-walk" onclick="pickMode('walk')">üö∂</button>
  <button class="mp-btn" id="mp-bike" onclick="pickMode('bike')">üö¥</button>
  <button class="mp-btn" id="mp-car" onclick="pickMode('car')">üöó</button>
</div>

<!-- SIMULATE (desktop) -->
<div class="dc">
  <div class="dlbl">Sim</div>
  <button class="dbtn" onclick="sim(0,-1)">‚Üë</button>
  <div class="drow"><button class="dbtn" onclick="sim(-1,0)">‚Üê</button><button class="dbtn" onclick="sim(1,0)">‚Üí</button></div>
  <button class="dbtn" onclick="sim(0,1)">‚Üì</button>
</div>

<div id="ms"><h3 id="msT"></h3><p id="msP"></p></div>

<!-- PHOTO MODAL -->
<div class="pmod" id="pmod">
  <div class="pmi">
    <h3>üìç Drop a Photo</h3>
    <div class="pia" onclick="$('pfile').click()"><img id="pprev"/><p id="pph">Tap to take a photo</p><input type="file" id="pfile" accept="image/*" capture="environment" onchange="prevPh(this)"/></div>
    <textarea class="pn" id="pnote" placeholder="Add a note..." rows="2"></textarea>
    <div class="pbs"><button class="bc" onclick="closePh()">Cancel</button><button class="bs" onclick="savePh()">Drop It</button></div>
  </div>
</div>

<!-- ACHIEVEMENTS PANEL -->
<div class="panel" id="achPanel">
  <div class="panel-inner">
    <div class="panel-head"><h2>Achievements</h2><div class="panel-close" onclick="$('achPanel').classList.remove('show')">‚úï</div></div>
    <div class="ach-grid" id="achGrid"></div>
  </div>
</div>

<!-- RECAP PANEL -->
<div class="panel" id="recapPanel">
  <div class="panel-inner">
    <div class="panel-head"><h2>Monthly Recap</h2><div class="panel-close" onclick="$('recapPanel').classList.remove('show')">‚úï</div></div>
    <div id="recapBody"></div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TERRA INCOGNITA v6
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const TILE_DEG=0.00025,GRID_R=150,TOTAL=(GRID_R*2+1)**2,DAILY_GOAL=50;
const MIN_MOVE=3,MAX_JUMP=0.5,SK='terra_v6';

const MODES={
  walk:{icon:'üö∂',min:0,max:8,radius:25,zoom:17,met:3.5},
  bike:{icon:'üö¥',min:8,max:25,radius:18,zoom:16,met:6.8},
  car:{icon:'üöó',min:25,max:999,radius:12,zoom:14,met:1.0}
};

// User profile for calories
let profile={sex:'male',wt:75,ht:175,setup:false};

// State
let map,fogC,fogX,heatC,heatX,cloudPat;
let uLat=null,uLng=null,oLat=null,oLng=null;
let revealed=new Set(),vc={},dist=0,calories=0;
let lastP=null,lastT=null,spd=0,mode='walk';
let msD=new Set(),uMark=null,accC=null,on=false;
let trail=null,trailPts=[];
let photos=[],pMarks=[],heatOn=false;
let streak={cur:0,last:null,today:0};
let fogLifted=false,autoMode=true,darkMap=false,ringsOn=false;
let distRings=[];
let satLayer=null,streetLayer=null,labelsLayer=null;
let achEarned=new Set();
let monthLog={}; // {YYYY-MM: {tiles,dist,cal,days:Set}}
let timeLog={}; // {hour: count} for time heatmap
const $=id=>document.getElementById(id);

function hap(s='light'){if(navigator.vibrate)navigator.vibrate(s==='heavy'?[30,10,30]:15)}

// ‚îÄ‚îÄ ACHIEVEMENTS ‚îÄ‚îÄ
const ACHIEVEMENTS=[
  {id:'first_steps',icon:'üë£',name:'First Steps',desc:'Reveal 10 tiles',check:()=>revealed.size>=10},
  {id:'century',icon:'üíØ',name:'Century',desc:'Reveal 100 tiles',check:()=>revealed.size>=100},
  {id:'explorer_500',icon:'üó∫Ô∏è',name:'Cartographer',desc:'500 tiles',check:()=>revealed.size>=500},
  {id:'explorer_1k',icon:'üèîÔ∏è',name:'Mountaineer',desc:'1000 tiles',check:()=>revealed.size>=1000},
  {id:'km_1',icon:'üèÉ',name:'First Kilometer',desc:'Walk 1 km',check:()=>dist>=1},
  {id:'km_5',icon:'ü•æ',name:'Trail Blazer',desc:'Walk 5 km',check:()=>dist>=5},
  {id:'km_10',icon:'üéñÔ∏è',name:'10K Day',desc:'Walk 10 km',check:()=>dist>=10},
  {id:'km_marathon',icon:'üèÖ',name:'Marathon',desc:'42.2 km total',check:()=>dist>=42.2},
  {id:'streak_3',icon:'üî•',name:'On Fire',desc:'3 day streak',check:()=>streak.cur>=3},
  {id:'streak_7',icon:'üí´',name:'Unstoppable',desc:'7 day streak',check:()=>streak.cur>=7},
  {id:'streak_30',icon:'üëë',name:'Legend',desc:'30 day streak',check:()=>streak.cur>=30},
  {id:'night_owl',icon:'ü¶â',name:'Night Owl',desc:'Explore after 10pm',check:()=>new Date().getHours()>=22&&revealed.size>0},
  {id:'early_bird',icon:'üê¶',name:'Early Bird',desc:'Explore before 6am',check:()=>new Date().getHours()<6&&revealed.size>0},
  {id:'cyclist',icon:'üö¥',name:'Cyclist',desc:'Use bike mode',check:()=>mode==='bike'},
  {id:'driver',icon:'üöó',name:'Road Trip',desc:'Use car mode',check:()=>mode==='car'},
  {id:'photographer',icon:'üì∏',name:'Shutterbug',desc:'Drop 5 photos',check:()=>photos.length>=5},
  {id:'cal_500',icon:'üî•',name:'Burn Baby',desc:'Burn 500 cal',check:()=>calories>=500},
  {id:'cal_2000',icon:'üí™',name:'Beast Mode',desc:'Burn 2000 cal',check:()=>calories>=2000},
];

function checkAch(){
  ACHIEVEMENTS.forEach(a=>{
    if(!achEarned.has(a.id)&&a.check()){
      achEarned.add(a.id);
      showMilestone(`${a.icon} ${a.name}`,a.desc);
    }
  });
}

function showAch(){
  const g=$('achGrid');
  g.innerHTML=ACHIEVEMENTS.map(a=>
    `<div class="ach ${achEarned.has(a.id)?'earned':''}"><div class="ach-icon">${a.icon}</div><div class="ach-name">${a.name}</div></div>`
  ).join('');
  $('achPanel').classList.add('show');
}

// ‚îÄ‚îÄ CALORIES ‚îÄ‚îÄ
function calcCal(distKm,mode){
  // MET * weight(kg) * time(hours)
  // time = dist / speed; approx from mode avg speed
  const avgSpd=mode==='walk'?5:mode==='bike'?16:40;
  const hours=distKm/avgSpd;
  return MODES[mode].met*profile.wt*hours;
}

// ‚îÄ‚îÄ MONTHLY RECAP ‚îÄ‚îÄ
function logMonth(){
  const key=today().slice(0,7);
  if(!monthLog[key])monthLog[key]={tiles:0,dist:0,cal:0,days:[]};
  const m=monthLog[key];
  m.tiles=revealed.size;m.dist=dist;m.cal=calories;
  if(!m.days.includes(today()))m.days.push(today());
}

function showRecap(){
  const key=today().slice(0,7);
  const m=monthLog[key]||{tiles:0,dist:0,cal:0,days:[]};
  const monthName=new Date().toLocaleString('default',{month:'long',year:'numeric'});
  $('recapBody').innerHTML=`
    <h3 style="font-family:'Cormorant Garamond',serif;font-size:18px;font-weight:300;color:var(--t1);margin-bottom:16px">${monthName}</h3>
    <div class="recap-stat"><span class="recap-label">Tiles explored</span><span class="recap-val">${m.tiles}</span></div>
    <div class="recap-stat"><span class="recap-label">Distance</span><span class="recap-val">${m.dist.toFixed(1)} km</span></div>
    <div class="recap-stat"><span class="recap-label">Calories burned</span><span class="recap-val">${Math.round(m.cal)}</span></div>
    <div class="recap-stat"><span class="recap-label">Active days</span><span class="recap-val">${m.days.length}</span></div>
    <div class="recap-stat"><span class="recap-label">Current streak</span><span class="recap-val">${streak.cur} üî•</span></div>
    <div class="recap-stat"><span class="recap-label">Daily goal</span><span class="recap-val">${streak.today}/${DAILY_GOAL}</span></div>
    <div class="recap-stat"><span class="recap-label">Most active hour</span><span class="recap-val">${getMostActiveHour()}</span></div>
  `;
  $('recapPanel').classList.add('show');
}

function getMostActiveHour(){
  let maxH=0,maxC=0;
  for(const[h,c]of Object.entries(timeLog)){if(c>maxC){maxC=c;maxH=h}}
  return maxC>0?`${maxH}:00`:'‚Äî';
}

// ‚îÄ‚îÄ SETUP ‚îÄ‚îÄ
function showSetup(){
  const saved=localStorage.getItem(SK+'_profile');
  if(saved){
    profile=JSON.parse(saved);
    if(profile.setup){startApp();return}
  }
  $('setup').classList.add('show');
  $('splash').classList.add('hidden');
}
function finishSetup(){
  profile.sex=$('s-sex').value;
  profile.wt=parseFloat($('s-wt').value)||75;
  profile.ht=parseFloat($('s-ht').value)||175;
  profile.setup=true;
  localStorage.setItem(SK+'_profile',JSON.stringify(profile));
  $('setup').classList.remove('show');
  startApp();
}
function skipSetup(){
  profile.setup=true;
  localStorage.setItem(SK+'_profile',JSON.stringify(profile));
  $('setup').classList.remove('show');
  startApp();
}

// ‚îÄ‚îÄ MAP ‚îÄ‚îÄ
function initMap(lat,lng){
  map=L.map('map',{center:[lat,lng],zoom:MODES[mode].zoom,zoomControl:false,attributionControl:false,maxZoom:19,minZoom:11});

  satLayer=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:19});
  streetLayer=L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{maxZoom:19});
  const roadsOverlay=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,opacity:0.3});
  labelsLayer=L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_only_labels/{z}/{x}/{y}{r}.png',{maxZoom:19,opacity:0.5});

  satLayer.addTo(map);
  roadsOverlay.addTo(map);
  labelsLayer.addTo(map);

  const svg=`<svg width="32" height="32" viewBox="0 0 32 32"><circle cx="16" cy="16" r="14" fill="none" stroke="rgba(110,196,168,.3)" stroke-width="2"><animate attributeName="r" values="8;14;8" dur="2.5s" repeatCount="indefinite"/><animate attributeName="opacity" values=".6;.1;.6" dur="2.5s" repeatCount="indefinite"/></circle><circle cx="16" cy="16" r="6" fill="#6ec4a8" stroke="#fff" stroke-width="2.5"/></svg>`;
  uMark=L.marker([lat,lng],{icon:L.divIcon({html:svg,className:'user-marker-icon',iconSize:[32,32],iconAnchor:[16,16]}),zIndexOffset:1000}).addTo(map);
  accC=L.circle([lat,lng],{radius:30,color:'rgba(110,196,168,.2)',fillColor:'rgba(110,196,168,.05)',weight:1,interactive:false}).addTo(map);
  trail=L.polyline([],{color:'#6ec4a8',weight:3,opacity:.5,smoothFactor:1,dashArray:'8,6'}).addTo(map);

  fogC=$('fog');fogX=fogC.getContext('2d');
  heatC=$('heat');heatX=heatC.getContext('2d');
  rzC();mkCloud();

  map.on('move zoom moveend zoomend resize',()=>{drawFog();if(heatOn)drawHeat();if(ringsOn)drawRings()});
  window.addEventListener('resize',()=>{rzC();drawFog()});

  photos.forEach(p=>addPMark(p));
  revealAt(lat,lng);drawFog();updateStreak();
}

function rzC(){fogC.width=heatC.width=innerWidth;fogC.height=heatC.height=innerHeight}

// ‚îÄ‚îÄ CLOUD ‚îÄ‚îÄ
function mkCloud(){
  const S=512,c=document.createElement('canvas');c.width=c.height=S;
  const cx=c.getContext('2d'),d=cx.createImageData(S,S);
  let _s=42;const rng=()=>{_s=(_s*16807)%2147483647;return(_s-1)/2147483646};
  const P=[];for(let i=0;i<256;i++)P[i]=i;
  for(let i=255;i>0;i--){const j=Math.floor(rng()*(i+1));[P[i],P[j]]=[P[j],P[i]]}
  for(let i=0;i<256;i++)P[i+256]=P[i];
  const fd=t=>t*t*t*(t*(t*6-15)+10),lp=(a,b,t)=>a+t*(b-a);
  const gr=(h,x,y)=>{const v=h&3;return((v&1)?-x:x)+((v&2)?-y:y)};
  const pn=(x,y)=>{const xi=Math.floor(x)&255,yi=Math.floor(y)&255,xf=x-Math.floor(x),yf=y-Math.floor(y),u=fd(xf),v=fd(yf);return lp(lp(gr(P[P[xi]+yi],xf,yf),gr(P[P[xi+1]+yi],xf-1,yf),u),lp(gr(P[P[xi]+yi+1],xf,yf-1),gr(P[P[xi+1]+yi+1],xf-1,yf-1),u),v)};
  for(let y=0;y<S;y++)for(let x=0;x<S;x++){
    let v=pn(x/64,y/64)*.5+pn(x/32,y/32)*.25+pn(x/16,y/16)*.12+pn(x/8,y/8)*.06;
    v=(v+1)*.5;v=Math.pow(Math.min(1,Math.max(0,v)),.75);
    const i=(y*S+x)*4,l=190+v*65;
    d.data[i]=l;d.data[i+1]=l+2;d.data[i+2]=l+8;d.data[i+3]=Math.floor(150+v*100);
  }
  cx.putImageData(d,0,0);cloudPat=fogX.createPattern(c,'repeat');
}

function g2g(la,lo){return[Math.floor((lo-oLng)/TILE_DEG),Math.floor((oLat-la)/TILE_DEG)]}
function g2ll(gx,gy){return[oLat-gy*TILE_DEG,oLng+gx*TILE_DEG]}

function revealAt(lat,lng){
  const rM=MODES[mode].radius,rDeg=rM/111000,rT=Math.ceil(rDeg/TILE_DEG);
  const[cx,cy]=g2g(lat,lng);let n=0;
  for(let dx=-rT;dx<=rT;dx++)for(let dy=-rT;dy<=rT;dy++){
    if(dx*dx+dy*dy>rT*rT)continue;
    const k=`${cx+dx},${cy+dy}`;vc[k]=(vc[k]||0)+1;
    if(!revealed.has(k)){revealed.add(k);n++}
  }
  if(n>0){hap(n>15?'heavy':'light');drawFog();updateStats();checkMS();checkAch();updateDaily(n);logTime();logMonth();saveState()}
}

// ‚îÄ‚îÄ FOG ‚îÄ‚îÄ
function drawFog(){
  if(!map||!fogX)return;
  const w=fogC.width,h=fogC.height;
  fogX.clearRect(0,0,w,h);fogX.save();
  fogX.globalAlpha=.9;fogX.fillStyle=cloudPat||'rgba(200,210,220,.9)';fogX.fillRect(0,0,w,h);
  fogX.globalAlpha=.15;fogX.fillStyle='rgba(200,210,225,1)';fogX.fillRect(0,0,w,h);
  fogX.globalAlpha=1;fogX.globalCompositeOperation='destination-out';

  // Circle around user ‚Äî exact perception radius
  if(uLat!==null){
    const pt=map.latLngToContainerPoint([uLat,uLng]);
    const rM=MODES[mode].radius;
    const pt2=map.latLngToContainerPoint([uLat+rM/111000,uLng]);
    const rPx=Math.abs(pt.y-pt2.y);
    const g=fogX.createRadialGradient(pt.x,pt.y,0,pt.x,pt.y,rPx);
    g.addColorStop(0,'rgba(0,0,0,1)');g.addColorStop(.75,'rgba(0,0,0,1)');g.addColorStop(.92,'rgba(0,0,0,.4)');g.addColorStop(1,'rgba(0,0,0,0)');
    fogX.fillStyle=g;fogX.beginPath();fogX.arc(pt.x,pt.y,rPx,0,Math.PI*2);fogX.fill();
  }

  // Explored tiles ‚Äî blur for soft edges
  const mC=document.createElement('canvas');mC.width=w;mC.height=h;const mX=mC.getContext('2d');
  revealed.forEach(k=>{
    const[gx,gy]=k.split(',').map(Number);
    const[la1,lo1]=g2ll(gx,gy),[la2,lo2]=g2ll(gx+1,gy+1);
    const p1=map.latLngToContainerPoint([la1,lo1]),p2=map.latLngToContainerPoint([la2,lo2]);
    mX.fillStyle='#000';mX.fillRect(Math.min(p1.x,p2.x),Math.min(p1.y,p2.y),Math.abs(p2.x-p1.x)+1,Math.abs(p2.y-p1.y)+1);
  });
  fogX.filter='blur(12px)';fogX.drawImage(mC,0,0);fogX.filter='none';
  fogX.globalAlpha=.7;fogX.drawImage(mC,0,0);fogX.globalAlpha=1;
  fogX.restore();
}

// ‚îÄ‚îÄ HEATMAP ‚îÄ‚îÄ
function togHeat(){heatOn=!heatOn;heatOn?($('heat').classList.add('on'),drawHeat()):$('heat').classList.remove('on')}
function drawHeat(){
  if(!map||!heatX)return;const w=heatC.width,h=heatC.height;heatX.clearRect(0,0,w,h);
  const mx=Math.max(1,...Object.values(vc));
  for(const[k,v]of Object.entries(vc)){
    const[gx,gy]=k.split(',').map(Number);const[la1,lo1]=g2ll(gx,gy),[la2,lo2]=g2ll(gx+1,gy+1);
    const p1=map.latLngToContainerPoint([la1,lo1]),p2=map.latLngToContainerPoint([la2,lo2]);const r=v/mx;
    const cl=r<.25?'42,90,74':r<.5?'110,196,168':r<.75?'232,180,74':'224,112,80';
    heatX.fillStyle=`rgba(${cl},${.15+r*.35})`;heatX.fillRect(Math.min(p1.x,p2.x),Math.min(p1.y,p2.y),Math.abs(p2.x-p1.x)+1,Math.abs(p2.y-p1.y)+1);
  }
}

// ‚îÄ‚îÄ DISTANCE RINGS ‚îÄ‚îÄ
function togRings(){ringsOn=!ringsOn;if(ringsOn)drawRings();else distRings.forEach(r=>map.removeLayer(r)),distRings=[]}
function drawRings(){
  distRings.forEach(r=>map.removeLayer(r));distRings=[];
  if(!uLat)return;
  [100,500,1000].forEach(m=>{
    const c=L.circle([uLat,uLng],{radius:m,color:'rgba(110,196,168,.15)',weight:1,dashArray:'6,6',fill:false,interactive:false}).addTo(map);
    // Label
    const labelLat=uLat+m/111000;
    const lab=L.marker([labelLat,uLng],{icon:L.divIcon({html:`<span style="font-size:8px;color:rgba(110,196,168,.35);letter-spacing:1px">${m>=1000?(m/1000)+'km':m+'m'}</span>`,className:'',iconAnchor:[-4,6]}),interactive:false}).addTo(map);
    distRings.push(c,lab);
  });
}

// ‚îÄ‚îÄ MAP STYLE TOGGLE ‚îÄ‚îÄ
function togMapStyle(){
  darkMap=!darkMap;
  if(darkMap){map.removeLayer(satLayer);streetLayer.addTo(map)}
  else{map.removeLayer(streetLayer);satLayer.addTo(map)}
}

// ‚îÄ‚îÄ FOG LIFT ‚îÄ‚îÄ
function togFogLift(){fogLifted=!fogLifted;$('fog').classList.toggle('lifted',fogLifted)}

// ‚îÄ‚îÄ TRAIL ‚îÄ‚îÄ
function addTrail(la,lo){trailPts.push([la,lo]);if(trailPts.length>5000)trailPts=trailPts.slice(-4000);if(trail)trail.setLatLngs(trailPts)}

// ‚îÄ‚îÄ GPS ‚îÄ‚îÄ
function startGPS(){
  if(!navigator.geolocation){setG('error','No GPS');fb();return}
  setG('searching','Searching‚Ä¶');
  navigator.geolocation.getCurrentPosition(p=>onFirst(p.coords),e=>{setG('error',e.code===1?'Denied':'Unavailable');fb()},{enableHighAccuracy:true,timeout:20000,maximumAge:0});
  navigator.geolocation.watchPosition(p=>onUpd(p.coords),()=>{},{enableHighAccuracy:true,maximumAge:2000,timeout:15000});
}
function fb(){if(!map){const la=oLat||25.6866,lo=oLng||-100.3161;oLat=oLat||la;oLng=oLng||lo;uLat=la;uLng=lo;initMap(la,lo);updateStats()}}

function onFirst(c){
  uLat=c.latitude;uLng=c.longitude;if(!oLat){oLat=c.latitude;oLng=c.longitude}
  setG('locked',`¬±${Math.round(c.accuracy)}m`);
  showC(c.latitude,c.longitude);
  if(!map){initMap(c.latitude,c.longitude);updateStats()}else map.setView([c.latitude,c.longitude],MODES[mode].zoom);
  addTrail(c.latitude,c.longitude);revealAt(c.latitude,c.longitude);
}

function onUpd(c){
  const lat=c.latitude,lng=c.longitude,acc=c.accuracy;
  setG('locked',`¬±${Math.round(acc)}m`);showC(lat,lng);
  if(uMark)uMark.setLatLng([lat,lng]);if(accC){accC.setLatLng([lat,lng]);accC.setRadius(acc)}
  if(c.heading&&!isNaN(c.heading))$('compass').style.transform=`rotate(${-c.heading}deg)`;
  if(ringsOn)drawRings();

  const now=Date.now();
  if(lastP&&lastT){
    const d=hav(lastP.lat,lastP.lng,lat,lng),dtH=(now-lastT)/3600000;
    if(dtH>0){spd=d/dtH;setModeFromSpeed(spd)}
    if(d*1000>MIN_MOVE&&d<MAX_JUMP){
      const cal=calcCal(d,mode);calories+=cal;
      dist+=d;uLat=lat;uLng=lng;lastP={lat,lng};lastT=now;
      addTrail(lat,lng);revealAt(lat,lng);return;
    }
  }
  if(!lastP||hav(lastP.lat,lastP.lng,lat,lng)*1000>MIN_MOVE){lastP={lat,lng};lastT=now;uLat=lat;uLng=lng;addTrail(lat,lng);revealAt(lat,lng)}
}

function hav(a,b,c,d){const R=6371,dA=(c-a)*Math.PI/180,dO=(d-b)*Math.PI/180;const x=Math.sin(dA/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dO/2)**2;return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x))}
function setG(s,t){$('gbadge').className='badge '+s;$('gtxt').textContent=t}
function showC(la,lo){$('coords').textContent=`${Math.abs(la).toFixed(5)}¬∞${la>=0?'N':'S'}  ${Math.abs(lo).toFixed(5)}¬∞${lo>=0?'E':'W'}`}

function setModeFromSpeed(kmh){
  if(autoMode){
    const prev=mode;
    if(kmh>=MODES.car.min)mode='car';else if(kmh>=MODES.bike.min)mode='bike';else mode='walk';
    if(prev!==mode)updateMPick();
  }
  const m=MODES[mode];
  if(kmh>2){$('mbadge').classList.add('on');$('mtxt').textContent=`${m.icon} ${Math.round(kmh)} km/h`}else $('mbadge').classList.remove('on');
  if(map){const cz=map.getZoom();if(Math.abs(cz-m.zoom)>1)map.flyTo([uLat,uLng],m.zoom,{duration:.8});drawFog()}
}

function pickMode(m){autoMode=false;mode=m;updateMPick();$('autolab').classList.remove('active');if(map){map.flyTo([uLat||oLat,uLng||oLng],MODES[m].zoom,{duration:.6});drawFog()}}
function togAuto(){autoMode=!autoMode;$('autolab').classList.toggle('active',autoMode);if(autoMode&&spd>0)setModeFromSpeed(spd)}
function updateMPick(){['walk','bike','car'].forEach(m=>$('mp-'+m).classList.toggle('sel',mode===m))}
function centerUser(){if(uLat&&map)map.flyTo([uLat,uLng],MODES[mode].zoom,{duration:.5})}

// ‚îÄ‚îÄ SIMULATE ‚îÄ‚îÄ
function sim(dx,dy){const s=TILE_DEG*1.8,la=(uLat||oLat)-dy*s,lo=(uLng||oLng)+dx*s;const d=hav(uLat||oLat,uLng||oLng,la,lo);dist+=d;calories+=calcCal(d,mode);uLat=la;uLng=lo;lastP={lat:la,lng:lo};lastT=Date.now();if(uMark)uMark.setLatLng([la,lo]);if(accC)accC.setLatLng([la,lo]);map.panTo([la,lo]);addTrail(la,lo);revealAt(la,lo);showC(la,lo);if(ringsOn)drawRings()}
document.addEventListener('keydown',e=>{if(!on)return;const m={ArrowUp:[0,-1],w:[0,-1],ArrowDown:[0,1],s:[0,1],ArrowRight:[1,0],d:[1,0],ArrowLeft:[-1,0],a:[-1,0]};if(m[e.key]){sim(...m[e.key]);e.preventDefault()}});

// ‚îÄ‚îÄ STATS ‚îÄ‚îÄ
function updateStats(){const n=revealed.size,p=n/TOTAL*100;$('vT').textContent=n;$('vP').textContent=p.toFixed(1)+'%';$('vD').textContent=dist.toFixed(2);$('vC').textContent=Math.round(calories);$('prog').style.width=Math.min(p*10,100)+'%'}

// ‚îÄ‚îÄ TIME LOG (for heatmap by time) ‚îÄ‚îÄ
function logTime(){const h=new Date().getHours();timeLog[h]=(timeLog[h]||0)+1}

// ‚îÄ‚îÄ DAILY/STREAK ‚îÄ‚îÄ
function today(){return new Date().toISOString().slice(0,10)}
function yest(){const d=new Date();d.setDate(d.getDate()-1);return d.toISOString().slice(0,10)}
function updateDaily(n){
  const t=today();if(streak.last!==t){if(streak.last===yest()&&streak.today>=DAILY_GOAL)streak.cur++;else if(streak.last!==yest())streak.cur=0;streak.today=0;streak.last=t}
  streak.today+=n;if(streak.today>=DAILY_GOAL&&streak.today-n<DAILY_GOAL){streak.cur++;hap('heavy');showMilestone('Daily Goal! üî•','Streak continues')}
  $('dfill').style.width=Math.min(streak.today/DAILY_GOAL*100,100)+'%';$('dcnt').textContent=`${Math.min(streak.today,DAILY_GOAL)}/${DAILY_GOAL}`;updateStreak();
}
function updateStreak(){$('stxt').textContent=streak.cur}

// ‚îÄ‚îÄ MILESTONES ‚îÄ‚îÄ
function checkMS(){const p=revealed.size/TOTAL*100;const ms=[[.02,'First Steps'],[.05,'Curious'],[.1,'Wanderer'],[.25,'Pathfinder'],[.5,'Scout'],[1,'Explorer'],[2,'Adventurer'],[5,'Cartographer'],[10,'Wayfinder'],[25,'Quarter Master'],[50,'Half the World'],[75,'Almost There'],[100,'Terra Cognita']];for(const[m,nm]of ms)if(p>=m&&!msD.has(m)){msD.add(m);showMilestone(nm,m>=1?`${m}% explored`:`${revealed.size} tiles`);break}}
function showMilestone(t,s){$('msT').textContent=t;$('msP').textContent=s;$('ms').classList.add('show');hap('heavy');setTimeout(()=>$('ms').classList.remove('show'),2800)}

// ‚îÄ‚îÄ PHOTOS ‚îÄ‚îÄ
let pendPh=null;
function openPhoto(){$('pmod').classList.add('show');$('pprev').style.display='none';$('pph').style.display='';$('pnote').value='';pendPh=null}
function closePh(){$('pmod').classList.remove('show')}
function prevPh(i){if(!i.files||!i.files[0])return;const r=new FileReader();r.onload=e=>{$('pprev').src=e.target.result;$('pprev').style.display='block';$('pph').style.display='none';pendPh=e.target.result};r.readAsDataURL(i.files[0])}
function savePh(){if(!pendPh||!uLat)return;const d={id:Date.now(),lat:uLat,lng:uLng,img:pendPh,note:$('pnote').value,date:new Date().toLocaleDateString()};photos.push(d);addPMark(d);closePh();hap('heavy');saveState()}
function addPMark(d){if(!map)return;const m=L.marker([d.lat,d.lng],{icon:L.divIcon({html:`<div class="pm"><img src="${d.img}"/></div>`,className:'',iconSize:[26,26],iconAnchor:[13,13]}),zIndexOffset:500}).addTo(map);m.bindPopup(`<div style="text-align:center;max-width:160px"><img src="${d.img}" style="width:100%;border-radius:6px;margin-bottom:4px"/><p style="font-size:10px;margin:0">${d.note||''}</p><small style="color:#888">${d.date}</small></div>`);pMarks.push(m)}

// ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ
function exportMap(){const l=document.createElement('a'),c=document.createElement('canvas'),w=innerWidth,h=innerHeight;c.width=w;c.height=h;const x=c.getContext('2d');x.fillStyle='#0a0e17';x.fillRect(0,0,w,h);x.drawImage(fogC,0,0);x.fillStyle='rgba(10,14,23,.7)';x.fillRect(0,h-60,w,60);x.font='300 22px Cormorant Garamond,serif';x.fillStyle='#6ec4a8';x.textAlign='center';x.fillText(`${revealed.size} tiles ¬∑ ${(revealed.size/TOTAL*100).toFixed(1)}% ¬∑ ${dist.toFixed(1)}km ¬∑ ${Math.round(calories)}cal`,w/2,h-28);x.font='10px DM Sans,sans-serif';x.fillStyle='#7a8a82';x.fillText('Terra Incognita',w/2,h-10);l.download=`terra-${today()}.png`;l.href=c.toDataURL('image/png');l.click();hap()}

// ‚îÄ‚îÄ SAVE/LOAD ‚îÄ‚îÄ
function saveState(){try{localStorage.setItem(SK,JSON.stringify({t:Array.from(revealed),vc,oLa:oLat,oLo:oLng,uLa:uLat,uLo:uLng,d:dist,cal:calories,m:Array.from(msD),tr:trailPts.slice(-2000),ph:photos.slice(-30),sk:streak,ach:Array.from(achEarned),ml:monthLog,tl:timeLog}))}catch(e){try{localStorage.setItem(SK,JSON.stringify({t:Array.from(revealed),vc,oLa:oLat,oLo:oLng,uLa:uLat,uLo:uLng,d:dist,cal:calories,m:Array.from(msD),sk:streak,ach:Array.from(achEarned)}))}catch(e2){}}}
function loadState(){try{const r=localStorage.getItem(SK);if(!r)return false;const s=JSON.parse(r);if(!s.oLa||!s.t?.length)return false;oLat=s.oLa;oLng=s.oLo;revealed=new Set(s.t);vc=s.vc||{};dist=s.d||0;calories=s.cal||0;msD=new Set(s.m||[]);trailPts=s.tr||[];photos=s.ph||[];streak=s.sk||{cur:0,last:null,today:0};achEarned=new Set(s.ach||[]);monthLog=s.ml||{};timeLog=s.tl||{};if(s.uLa){uLat=s.uLa;uLng=s.uLo}return true}catch(e){return false}}
function doReset(){if(confirm('Reset ALL progress?')){localStorage.removeItem(SK);revealed=new Set();vc={};dist=0;calories=0;msD=new Set();trailPts=[];photos=[];pMarks.forEach(m=>map.removeLayer(m));pMarks=[];streak={cur:0,last:null,today:0};achEarned=new Set();monthLog={};timeLog={};if(trail)trail.setLatLngs([]);if(ringsOn){distRings.forEach(r=>map.removeLayer(r));distRings=[]}oLat=uLat;oLng=uLng;drawFog();updateStats();updateStreak();$('dfill').style.width='0%';$('dcnt').textContent=`0/${DAILY_GOAL}`;if(uLat)revealAt(uLat,uLng)}}

// ‚îÄ‚îÄ TOOLS MENU ‚îÄ‚îÄ
function togMenu(){$('toolsMenu').classList.toggle('show');if($('toolsMenu').classList.contains('show'))updMenuState()}
function updMenuState(){
  $('ti-fog').classList.toggle('active',fogLifted);
  $('ti-map').classList.toggle('active',darkMap);
  $('ti-ring').classList.toggle('active',ringsOn);
  $('ti-heat').classList.toggle('active',heatOn);
}

// ‚îÄ‚îÄ ZOOM OVERRIDE ‚Äî pause auto-zoom when user touches the map ‚îÄ‚îÄ
let userZooming=false,zoomTimer=null;
function initZoomOverride(){
  if(!map)return;
  map.on('zoomstart',()=>{
    // Check if zoom was triggered by user (touch/scroll) vs programmatic
    if(!map._flyToFrame){
      userZooming=true;
      clearTimeout(zoomTimer);
      zoomTimer=setTimeout(()=>{userZooming=false},10000); // 10s cooldown
    }
  });
}

// ‚îÄ‚îÄ DATA BACKUP/RESTORE ‚îÄ‚îÄ
function backupData(){
  const data={
    v:6,date:today(),
    state:localStorage.getItem(SK),
    profile:localStorage.getItem(SK+'_profile')
  };
  const blob=new Blob([JSON.stringify(data)],{type:'application/json'});
  const a=document.createElement('a');
  a.download=`terra-backup-${today()}.json`;
  a.href=URL.createObjectURL(blob);
  a.click();
  URL.revokeObjectURL(a.href);
  hap();showMilestone('üíæ Backup Saved','Your data is safe');
}

function restoreData(input){
  if(!input.files||!input.files[0])return;
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const data=JSON.parse(e.target.result);
      if(data.state)localStorage.setItem(SK,data.state);
      if(data.profile)localStorage.setItem(SK+'_profile',data.profile);
      showMilestone('üìÇ Restored','Reloading...');
      setTimeout(()=>location.reload(),1500);
    }catch(err){alert('Invalid backup file')}
  };
  reader.readAsText(input.files[0]);
}

// ‚îÄ‚îÄ START ‚îÄ‚îÄ
function startApp(){
  on=true;$('splash').classList.add('hidden');
  const p=localStorage.getItem(SK+'_profile');if(p)profile=JSON.parse(p);
  const h=loadState();startGPS();
  if(h&&!map){initMap(uLat||oLat,uLng||oLng);updateStats();if(trail&&trailPts.length)trail.setLatLngs(trailPts);$('dfill').style.width=Math.min(streak.today/DAILY_GOAL*100,100)+'%';$('dcnt').textContent=`${Math.min(streak.today,DAILY_GOAL)}/${DAILY_GOAL}`}
}
</script>
</body>
</html>
