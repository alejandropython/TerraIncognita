<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Terra">
<meta name="theme-color" content="#0a0e17">
<title>Terra Incognita</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<style>
:root{--bg:#0a0e17;--card:rgba(17,24,39,.93);--accent:#6ec4a8;--accent-dim:#3a7d66;--glow:rgba(110,196,168,.4);--text:#e8ece9;--text2:#7a8a82;--text3:#4a5a52;--border:rgba(110,196,168,.12);--r:16px}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;width:100%;overflow:hidden;font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;touch-action:none}

#splash{position:fixed;inset:0;z-index:2000;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity .8s,visibility .8s}
#splash.hidden{opacity:0;visibility:hidden;pointer-events:none}
.logo-mark{width:80px;height:80px;border-radius:50%;border:2px solid var(--accent);display:flex;align-items:center;justify-content:center;margin-bottom:32px;position:relative;animation:pulse 2.5s ease-in-out infinite}
.logo-mark::after{content:'';position:absolute;inset:-8px;border-radius:50%;border:1px solid rgba(110,196,168,.15);animation:pulse 2.5s ease-in-out infinite .3s}
@keyframes pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.05);opacity:.7}}
.logo-mark svg{width:36px;height:36px}
#splash h1{font-family:'Cormorant Garamond',serif;font-size:32px;font-weight:300;letter-spacing:6px;text-transform:uppercase;margin-bottom:8px}
#splash .sub{font-size:13px;color:var(--text2);letter-spacing:3px;text-transform:uppercase;margin-bottom:48px}
.start-btn{background:0 0;border:1px solid var(--accent);color:var(--accent);padding:14px 48px;border-radius:40px;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:500;letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:.3s}
.start-btn:hover{background:var(--accent);color:var(--bg);box-shadow:0 0 30px var(--glow)}
.install-hint{margin-top:32px;max-width:300px;text-align:center;font-size:12px;color:var(--text3);line-height:1.7;opacity:0;animation:fadeIn 1s 1.5s forwards}
.install-hint strong{color:var(--text2)}
@keyframes fadeIn{to{opacity:1}}

#map{position:absolute;inset:0;z-index:1;background:var(--bg)}
.leaflet-control-attribution,.leaflet-control-zoom{display:none!important}
#fog{position:absolute;inset:0;z-index:500;pointer-events:none}

#top-bar{position:fixed;top:0;left:0;right:0;padding:14px 20px;padding-top:max(14px,env(safe-area-inset-top));display:flex;justify-content:space-between;align-items:center;z-index:1000;background:linear-gradient(to bottom,rgba(10,14,23,.92),rgba(10,14,23,.5) 60%,transparent);pointer-events:none}
#top-bar>*{pointer-events:all}
.app-title{font-family:'Cormorant Garamond',serif;font-size:18px;font-weight:300;letter-spacing:4px;text-transform:uppercase}
.top-right{display:flex;gap:8px;align-items:center}
.icon-btn{width:40px;height:40px;border-radius:50%;background:var(--card);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:.3s;color:var(--text2);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px)}
.icon-btn:hover,.icon-btn.active{border-color:var(--accent);color:var(--accent);box-shadow:0 0 20px rgba(110,196,168,.15)}
.icon-btn svg{width:18px;height:18px}

.gps-badge{display:flex;align-items:center;gap:6px;padding:6px 14px;border-radius:20px;background:var(--card);border:1px solid var(--border);font-size:11px;letter-spacing:1px;text-transform:uppercase;color:var(--text2);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);transition:.4s}
.gps-badge .dot{width:7px;height:7px;border-radius:50%;background:var(--text3);transition:.4s}
.gps-badge.searching .dot{background:#e8b44a;animation:blink 1s ease-in-out infinite}
.gps-badge.locked .dot{background:var(--accent);box-shadow:0 0 8px var(--glow)}
.gps-badge.locked{color:var(--accent);border-color:rgba(110,196,168,.25)}
.gps-badge.error .dot{background:#e05555}
.gps-badge.error{color:#e05555}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

.speed-badge{display:none;align-items:center;gap:5px;padding:5px 12px;border-radius:20px;background:var(--card);border:1px solid var(--border);font-size:11px;letter-spacing:1px;color:var(--text2);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px)}
.speed-badge.show{display:flex}

#stats-panel{position:fixed;bottom:0;left:0;right:0;z-index:1000;padding:0 16px;padding-bottom:max(20px,env(safe-area-inset-bottom));pointer-events:none}
.stats-card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:20px 24px;pointer-events:all;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px)}
.stats-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.stat-block{text-align:center;flex:1}
.stat-block+.stat-block{border-left:1px solid var(--border)}
.stat-value{font-family:'Cormorant Garamond',serif;font-size:28px;font-weight:300;color:var(--accent);line-height:1;margin-bottom:4px}
.stat-label{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--text2)}
.progress-container{position:relative;height:4px;background:rgba(110,196,168,.08);border-radius:2px;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--accent-dim),var(--accent));border-radius:2px;transition:width .6s cubic-bezier(.22,1,.36,1);position:relative}
.progress-fill::after{content:'';position:absolute;right:0;top:-2px;width:8px;height:8px;border-radius:50%;background:var(--accent);box-shadow:0 0 10px var(--glow)}

#milestone{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(.9);z-index:2000;background:rgba(17,24,39,.96);border:1px solid var(--accent);border-radius:var(--r);padding:32px 48px;text-align:center;opacity:0;visibility:hidden;transition:.5s cubic-bezier(.22,1,.36,1);box-shadow:0 0 60px rgba(110,196,168,.2);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px)}
#milestone.show{opacity:1;visibility:visible;transform:translate(-50%,-50%) scale(1)}
#milestone h3{font-family:'Cormorant Garamond',serif;font-size:24px;font-weight:300;color:var(--accent);margin-bottom:8px}
#milestone p{font-size:13px;color:var(--text2)}

.user-marker-icon{background:none!important;border:none!important}
.coords{position:fixed;bottom:130px;left:16px;z-index:1000;font-size:10px;letter-spacing:1px;color:var(--text3);font-family:'DM Sans',monospace}

.demo-ctrl{position:fixed;bottom:140px;right:16px;z-index:1000;display:flex;flex-direction:column;gap:5px;align-items:center}
.demo-row{display:flex;gap:5px}
.demo-btn{width:40px;height:40px;border-radius:50%;background:var(--card);border:1px solid var(--border);color:var(--text2);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:15px;transition:.2s;backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px)}
.demo-btn:hover{border-color:var(--accent);color:var(--accent)}
.demo-btn:active{transform:scale(.9)}
.demo-lbl{font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--text3);margin-bottom:2px}
</style>
</head>
<body>

<div id="splash">
  <div class="logo-mark">
    <svg viewBox="0 0 24 24" fill="none" stroke="#6ec4a8" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20z"/><path d="M2 12h20"/></svg>
  </div>
  <h1>Terra Incognita</h1>
  <p class="sub">Uncover your city</p>
  <button class="start-btn" onclick="startApp()">Begin Exploring</button>
  <div class="install-hint">
    <strong>ğŸ“± To use on iPhone:</strong><br>
    1. Host this file online (e.g. Netlify Drop, GitHub Pages, or Tiiny.host â€” all free)<br>
    2. Open the URL in <strong>Safari</strong><br>
    3. Tap <strong>Share â¬† â†’ Add to Home Screen</strong><br>
    It runs as a full-screen app with live GPS.
  </div>
</div>

<div id="map"></div>
<canvas id="fog"></canvas>

<div id="top-bar">
  <div class="app-title">Terra</div>
  <div class="top-right">
    <div class="speed-badge" id="speed-badge"><span id="speed-text">0 km/h</span></div>
    <div class="gps-badge" id="gps-badge"><div class="dot"></div><span id="gps-text">No GPS</span></div>
    <button class="icon-btn" onclick="centerOnUser()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 2v4m0 12v4M2 12h4m12 0h4"/></svg></button>
    <button class="icon-btn" onclick="confirmReset()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg></button>
  </div>
</div>

<div id="stats-panel"><div class="stats-card">
  <div class="stats-row">
    <div class="stat-block"><div class="stat-value" id="s-tiles">0</div><div class="stat-label">Tiles</div></div>
    <div class="stat-block"><div class="stat-value" id="s-pct">0%</div><div class="stat-label">Explored</div></div>
    <div class="stat-block"><div class="stat-value" id="s-dist">0</div><div class="stat-label">Km</div></div>
    <div class="stat-block"><div class="stat-value" id="s-acc">â€”</div><div class="stat-label">GPS Â±m</div></div>
  </div>
  <div class="progress-container"><div class="progress-fill" id="prog" style="width:0%"></div></div>
</div></div>

<div class="coords" id="coords">â€”</div>

<div class="demo-ctrl">
  <div class="demo-lbl">Simulate</div>
  <button class="demo-btn" onclick="simWalk(0,-1)">â†‘</button>
  <div class="demo-row"><button class="demo-btn" onclick="simWalk(-1,0)">â†</button><button class="demo-btn" onclick="simWalk(1,0)">â†’</button></div>
  <button class="demo-btn" onclick="simWalk(0,1)">â†“</button>
</div>

<div id="milestone"><h3 id="m-title"></h3><p id="m-text"></p></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TERRA INCOGNITA v3 â€” Satellite + Clouds
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const TILE_DEG     = 0.00025;  // ~27m per fog tile
const REVEAL_WALK  = 2;        // tile radius on foot/bike
const REVEAL_CAR   = 5;        // tile radius when driving
const CAR_THRESH   = 12;       // km/h â€” above this = car mode
const GRID_R       = 150;
const TOTAL        = (GRID_R*2+1)**2;
const MIN_MOVE     = 3;        // meters
const MAX_JUMP     = 0.5;      // km â€” filter GPS glitches
const SAVE_KEY     = 'terra_v3';

let map, fogCvs, fogCtx, cloudPat;
let userLat=null, userLng=null, originLat=null, originLng=null;
let revealed=new Set(), totalDist=0, lastPos=null, lastTime=null;
let speed=0, msDone=new Set(), userMarker=null, accCircle=null, started=false;

// â”€â”€ MAP â”€â”€
function initMap(lat,lng){
  map=L.map('map',{center:[lat,lng],zoom:16,zoomControl:false,attributionControl:false,maxZoom:19,minZoom:13});

  // â˜… Satellite imagery (Esri)
  L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:19}).addTo(map);

  // Slightly enhance satellite contrast
  const tp=document.querySelector('.leaflet-tile-pane');
  if(tp) tp.style.filter='brightness(0.9) contrast(1.08) saturate(1.1)';

  // User dot
  const svg=`<svg width="32" height="32" viewBox="0 0 32 32">
    <circle cx="16" cy="16" r="14" fill="none" stroke="rgba(110,196,168,.3)" stroke-width="2">
      <animate attributeName="r" values="8;14;8" dur="2.5s" repeatCount="indefinite"/>
      <animate attributeName="opacity" values=".6;.1;.6" dur="2.5s" repeatCount="indefinite"/>
    </circle>
    <circle cx="16" cy="16" r="6" fill="#6ec4a8" stroke="#fff" stroke-width="2.5"/>
  </svg>`;
  userMarker=L.marker([lat,lng],{icon:L.divIcon({html:svg,className:'user-marker-icon',iconSize:[32,32],iconAnchor:[16,16]}),zIndexOffset:1000}).addTo(map);
  accCircle=L.circle([lat,lng],{radius:30,color:'rgba(110,196,168,.25)',fillColor:'rgba(110,196,168,.06)',weight:1,interactive:false}).addTo(map);

  fogCvs=document.getElementById('fog');
  fogCtx=fogCvs.getContext('2d');
  resizeFog();
  makeCloudTexture();

  map.on('move zoom moveend zoomend resize',drawFog);
  window.addEventListener('resize',()=>{resizeFog();drawFog()});

  revealAt(lat,lng);
  drawFog();
}

function resizeFog(){fogCvs.width=window.innerWidth;fogCvs.height=window.innerHeight}

// â”€â”€ CLOUD TEXTURE â”€â”€
function makeCloudTexture(){
  const S=512, c=document.createElement('canvas');
  c.width=c.height=S;
  const ctx=c.getContext('2d'), d=ctx.createImageData(S,S);

  // Hash-based noise
  const H=(a,b)=>{let h=(a*2654435761^b*2246822519)&0x7fffffff;h=((h>>13)^h)*1274126177;return((h>>16)^h)/2147483647};
  const sm=t=>t*t*(3-2*t);
  const N=(x,y)=>{const ix=Math.floor(x),iy=Math.floor(y),fx=sm(x-ix),fy=sm(y-iy);return H(ix,iy)*(1-fx)*(1-fy)+H(ix+1,iy)*fx*(1-fy)+H(ix,iy+1)*(1-fx)*fy+H(ix+1,iy+1)*fx*fy};

  for(let y=0;y<S;y++) for(let x=0;x<S;x++){
    // Multi-octave fractal noise â†’ cloud look
    let v=N(x/80,y/80)*.45+N(x/40,y/40)*.25+N(x/20,y/20)*.15+N(x/10,y/10)*.08;
    v=Math.min(1,Math.max(0,v*1.4));
    const i=(y*S+x)*4;
    // White/light-grey clouds
    const b=200+v*55;
    d.data[i]=b; d.data[i+1]=b+2; d.data[i+2]=b+8;
    d.data[i+3]=Math.floor(120+v*130); // 120-250 alpha
  }
  ctx.putImageData(d,0,0);
  cloudPat=fogCtx.createPattern(c,'repeat');
}

// â”€â”€ FOG (CLOUD STYLE) â”€â”€
function g2g(lat,lng){return[Math.floor((lng-originLng)/TILE_DEG),Math.floor((originLat-lat)/TILE_DEG)]}
function g2ll(gx,gy){return[originLat-gy*TILE_DEG,originLng+gx*TILE_DEG]}

function revealAt(lat,lng){
  const[cx,cy]=g2g(lat,lng);
  const r=speed>CAR_THRESH?REVEAL_CAR:REVEAL_WALK;
  let n=0;
  for(let dx=-r;dx<=r;dx++) for(let dy=-r;dy<=r;dy++){
    if(dx*dx+dy*dy>r*r+1) continue;
    const k=`${cx+dx},${cy+dy}`;
    if(!revealed.has(k)){revealed.add(k);n++}
  }
  if(n>0){drawFog();updateStats();checkMS();saveState()}
}

function drawFog(){
  if(!map||!fogCtx) return;
  const w=fogCvs.width, h=fogCvs.height;
  fogCtx.clearRect(0,0,w,h);
  fogCtx.save();

  // 1. Cloud texture layer
  fogCtx.globalAlpha=0.88;
  fogCtx.fillStyle=cloudPat||'rgba(210,215,225,.88)';
  fogCtx.fillRect(0,0,w,h);

  // 2. Tint overlay for density
  fogCtx.globalAlpha=0.25;
  fogCtx.fillStyle='rgba(190,200,215,1)';
  fogCtx.fillRect(0,0,w,h);
  fogCtx.globalAlpha=1;

  // 3. Cut revealed tiles
  fogCtx.globalCompositeOperation='destination-out';
  revealed.forEach(k=>{
    const[gx,gy]=k.split(',').map(Number);
    const[la1,lo1]=g2ll(gx,gy),[la2,lo2]=g2ll(gx+1,gy+1);
    const p1=map.latLngToContainerPoint([la1,lo1]),p2=map.latLngToContainerPoint([la2,lo2]);
    fogCtx.fillStyle='rgba(0,0,0,1)';
    fogCtx.fillRect(Math.min(p1.x,p2.x)-1,Math.min(p1.y,p2.y)-1,Math.abs(p2.x-p1.x)+2,Math.abs(p2.y-p1.y)+2);
  });

  // 4. Feathered edges for soft cloud dissolve
  revealed.forEach(k=>{
    const[gx,gy]=k.split(',').map(Number);
    const adj=[`${gx-1},${gy}`,`${gx+1},${gy}`,`${gx},${gy-1}`,`${gx},${gy+1}`];
    if(!adj.some(n=>!revealed.has(n))) return;
    const[la1,lo1]=g2ll(gx,gy),[la2,lo2]=g2ll(gx+1,gy+1);
    const p1=map.latLngToContainerPoint([la1,lo1]),p2=map.latLngToContainerPoint([la2,lo2]);
    const cx2=(p1.x+p2.x)/2, cy2=(p1.y+p2.y)/2, r=Math.abs(p2.x-p1.x)*3;
    const gr=fogCtx.createRadialGradient(cx2,cy2,0,cx2,cy2,r);
    gr.addColorStop(0,'rgba(0,0,0,0.45)');
    gr.addColorStop(0.3,'rgba(0,0,0,0.15)');
    gr.addColorStop(1,'rgba(0,0,0,0)');
    fogCtx.fillStyle=gr;
    fogCtx.fillRect(cx2-r,cy2-r,r*2,r*2);
  });

  fogCtx.restore();
}

// â”€â”€ GPS â”€â”€
function startGPS(){
  if(!navigator.geolocation){setGPS('error','No GPS');fallback();return}
  setGPS('searching','Searchingâ€¦');
  navigator.geolocation.getCurrentPosition(
    p=>onFirst(p.coords),
    e=>{setGPS('error',e.code===1?'Denied':'Unavailable');fallback()},
    {enableHighAccuracy:true,timeout:20000,maximumAge:0}
  );
  navigator.geolocation.watchPosition(
    p=>onUpdate(p.coords),
    ()=>{},
    {enableHighAccuracy:true,maximumAge:2000,timeout:15000}
  );
}

function fallback(){
  if(!map){
    const la=originLat||25.6866, lo=originLng||-100.3161;
    originLat=originLat||la; originLng=originLng||lo;
    userLat=la; userLng=lo;
    initMap(la,lo); updateStats();
  }
}

function onFirst(c){
  userLat=c.latitude; userLng=c.longitude;
  if(!originLat){originLat=c.latitude;originLng=c.longitude}
  setGPS('locked',`Â±${Math.round(c.accuracy)}m`);
  el('s-acc').textContent=Math.round(c.accuracy);
  showCoords(c.latitude,c.longitude);
  if(!map){initMap(c.latitude,c.longitude);updateStats()}
  else map.setView([c.latitude,c.longitude],16);
  revealAt(c.latitude,c.longitude);
}

function onUpdate(c){
  const lat=c.latitude, lng=c.longitude, acc=c.accuracy;
  setGPS('locked',`Â±${Math.round(acc)}m`);
  el('s-acc').textContent=Math.round(acc);
  showCoords(lat,lng);
  if(userMarker)userMarker.setLatLng([lat,lng]);
  if(accCircle){accCircle.setLatLng([lat,lng]);accCircle.setRadius(acc)}

  const now=Date.now();
  if(lastPos&&lastTime){
    const d=hav(lastPos.lat,lastPos.lng,lat,lng);
    const dtH=(now-lastTime)/3600000;
    if(dtH>0){
      speed=d/dtH;
      showSpeed(speed);
    }
    if(d*1000>MIN_MOVE && d<MAX_JUMP){
      totalDist+=d;
      userLat=lat;userLng=lng;lastPos={lat,lng};lastTime=now;
      revealAt(lat,lng);
      return;
    }
  }
  if(!lastPos||hav(lastPos.lat,lastPos.lng,lat,lng)*1000>MIN_MOVE){
    lastPos={lat,lng};lastTime=now;userLat=lat;userLng=lng;
    revealAt(lat,lng);
  }
}

function hav(a,b,c,d){const R=6371,dLa=(c-a)*Math.PI/180,dLo=(d-b)*Math.PI/180;const x=Math.sin(dLa/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLo/2)**2;return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x))}

function setGPS(s,t){const b=el('gps-badge');b.className='gps-badge '+s;el('gps-text').textContent=t}
function showCoords(la,lo){el('coords').textContent=`${Math.abs(la).toFixed(5)}Â°${la>=0?'N':'S'}  ${Math.abs(lo).toFixed(5)}Â°${lo>=0?'E':'W'}`}
function showSpeed(k){const e=el('speed-badge'),t=el('speed-text');if(k>3){e.classList.add('show');t.textContent=k>CAR_THRESH?`ğŸš— ${Math.round(k)} km/h`:`ğŸš¶ ${Math.round(k)} km/h`}else e.classList.remove('show')}
function centerOnUser(){if(userLat&&map)map.flyTo([userLat,userLng],16,{duration:.5})}
function el(id){return document.getElementById(id)}

// â”€â”€ SIMULATE â”€â”€
function simWalk(dx,dy){
  const s=TILE_DEG*1.8;
  const la=(userLat||originLat)-dy*s, lo=(userLng||originLng)+dx*s;
  totalDist+=hav(userLat||originLat,userLng||originLng,la,lo);
  userLat=la;userLng=lo;lastPos={lat:la,lng:lo};lastTime=Date.now();
  if(userMarker)userMarker.setLatLng([la,lo]);
  if(accCircle)accCircle.setLatLng([la,lo]);
  map.panTo([la,lo]);
  revealAt(la,lo);showCoords(la,lo);
}
document.addEventListener('keydown',e=>{
  if(!started)return;
  const m={ArrowUp:[0,-1],w:[0,-1],ArrowDown:[0,1],s:[0,1],ArrowRight:[1,0],d:[1,0],ArrowLeft:[-1,0],a:[-1,0]};
  if(m[e.key]){simWalk(...m[e.key]);e.preventDefault()}
});

// â”€â”€ STATS â”€â”€
function updateStats(){
  const n=revealed.size, p=n/TOTAL*100;
  el('s-tiles').textContent=n;
  el('s-pct').textContent=p.toFixed(1)+'%';
  el('s-dist').textContent=totalDist.toFixed(2);
  el('prog').style.width=Math.min(p*10,100)+'%';
}

// â”€â”€ MILESTONES â”€â”€
function checkMS(){
  const p=revealed.size/TOTAL*100;
  const ms=[[.02,'First Steps'],[.05,'Curious'],[.1,'Wanderer'],[.25,'Pathfinder'],[.5,'Scout'],[1,'Explorer'],[2,'Adventurer'],[5,'Cartographer'],[10,'Wayfinder'],[25,'Quarter Master'],[50,'Half the World'],[75,'Almost There'],[100,'Terra Cognita']];
  for(const[m,nm]of ms)if(p>=m&&!msDone.has(m)){msDone.add(m);showMS(nm,m);break}
}
function showMS(t,p){
  el('m-title').textContent=t;
  el('m-text').textContent=p>=1?`You've explored ${p}% of the map`:`${revealed.size} tiles uncovered`;
  el('milestone').classList.add('show');
  setTimeout(()=>el('milestone').classList.remove('show'),2800);
}

// â”€â”€ SAVE/LOAD â”€â”€
function saveState(){try{localStorage.setItem(SAVE_KEY,JSON.stringify({t:Array.from(revealed),oLa:originLat,oLo:originLng,uLa:userLat,uLo:userLng,d:totalDist,m:Array.from(msDone)}))}catch(e){}}
function loadState(){try{const r=localStorage.getItem(SAVE_KEY);if(!r)return false;const s=JSON.parse(r);if(!s.oLa||!s.t?.length)return false;originLat=s.oLa;originLng=s.oLo;revealed=new Set(s.t);totalDist=s.d||0;msDone=new Set(s.m||[]);if(s.uLa){userLat=s.uLa;userLng=s.uLo}return true}catch(e){return false}}
function confirmReset(){if(confirm('Reset all exploration progress?')){localStorage.removeItem(SAVE_KEY);revealed=new Set();totalDist=0;msDone=new Set();originLat=userLat;originLng=userLng;drawFog();updateStats();if(userLat)revealAt(userLat,userLng)}}

// â”€â”€ START â”€â”€
function startApp(){
  started=true;
  el('splash').classList.add('hidden');
  const has=loadState();
  startGPS();
  if(has&&!map){initMap(userLat||originLat,userLng||originLng);updateStats()}
}
</script>
</body>
</html>
